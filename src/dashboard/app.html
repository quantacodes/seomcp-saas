<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard ‚Äî seomcp.dev</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîç</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            brand: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' },
            surface: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569' },
          }
        }
      }
    }
  </script>
  <style>
    body { background: #0f172a; color: #f8fafc; }
    .gradient-text {
      background: linear-gradient(135deg, #0ea5e9, #38bdf8, #7dd3fc);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .code-block { background: #0d1117; border: 1px solid #30363d; }
    .bar { min-width: 2px; transition: height 0.3s ease; }
    .status-success { background: #22c55e; }
    .status-error { background: #ef4444; }
    .status-rate_limited { background: #eab308; }
    .badge-success { color: #22c55e; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); }
    .badge-error { color: #ef4444; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); }
    .badge-rate_limited { color: #eab308; background: rgba(234,179,8,0.1); border: 1px solid rgba(234,179,8,0.2); }
    .badge-active { color: #22c55e; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); }
    .badge-revoked { color: #94a3b8; background: rgba(148,163,184,0.1); border: 1px solid rgba(148,163,184,0.2); }
    .modal-overlay {
      display: none; position: fixed; inset: 0; z-index: 50;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
      align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .copy-toast {
      position: fixed; bottom: 2rem; right: 2rem; z-index: 100;
      background: #22c55e; color: white; padding: 0.75rem 1.5rem;
      border-radius: 0.5rem; font-weight: 600;
      transform: translateY(100px); opacity: 0; transition: all 0.3s ease;
    }
    .copy-toast.show { transform: translateY(0); opacity: 1; }
    .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body class="font-sans antialiased">

  <!-- Top Nav -->
  <nav class="sticky top-0 z-40 bg-surface-900/95 backdrop-blur-xl border-b border-white/5">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 h-14 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2 text-base font-bold">
        <span class="text-xl">üîç</span>
        <span class="gradient-text">seomcp</span><span class="text-slate-400">.dev</span>
      </a>
      <div class="flex items-center gap-4">
        <span id="plan-badge" class="hidden px-2.5 py-0.5 rounded-full text-xs font-medium bg-brand-500/10 text-brand-300 border border-brand-500/30 uppercase"></span>
        <span id="user-email" class="text-sm text-slate-400 hidden sm:inline"></span>
        <button onclick="handleLogout()" class="text-sm text-slate-500 hover:text-white transition">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-8 space-y-8">

    <!-- Loading State -->
    <div id="loading" class="space-y-8">
      <div class="skeleton h-32 rounded-2xl"></div>
      <div class="skeleton h-48 rounded-2xl"></div>
      <div class="skeleton h-64 rounded-2xl"></div>
    </div>

    <!-- Quick Start Banner (hidden until loaded) -->
    <div id="quickstart" class="hidden bg-gradient-to-r from-brand-700/20 to-brand-500/10 border border-brand-500/20 rounded-2xl p-6 sm:p-8 relative">
      <button onclick="dismissQuickstart()" class="absolute top-4 right-4 text-slate-500 hover:text-white text-lg">√ó</button>
      <h2 class="text-lg font-bold mb-1">üöÄ Quick Start</h2>
      <p class="text-sm text-slate-300 mb-4">Add this to your AI tool's MCP config to get started:</p>
      <div class="code-block rounded-xl overflow-hidden">
        <div class="flex items-center justify-between px-4 py-2 border-b border-white/5">
          <span class="text-xs text-slate-500 font-mono">mcp_config.json</span>
          <button onclick="copyText(document.getElementById('qs-config').textContent)" class="text-xs text-slate-400 hover:text-white transition">Copy</button>
        </div>
        <pre class="p-4 text-xs font-mono overflow-x-auto"><code id="qs-config" class="text-slate-300"></code></pre>
      </div>
    </div>

    <!-- Usage Overview -->
    <section id="usage-section" class="hidden">
      <div class="bg-surface-800 border border-white/5 rounded-2xl p-6 sm:p-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-bold">Usage This Month</h2>
          <span id="usage-period" class="text-sm text-slate-500"></span>
        </div>

        <div class="grid sm:grid-cols-4 gap-6 mb-8">
          <!-- Main counter -->
          <div class="sm:col-span-2">
            <div class="flex items-baseline gap-2 mb-2">
              <span id="usage-used" class="text-4xl font-extrabold"></span>
              <span class="text-slate-500">/</span>
              <span id="usage-limit" class="text-2xl text-slate-400"></span>
              <span class="text-sm text-slate-500">calls</span>
            </div>
            <div class="w-full h-3 bg-surface-700 rounded-full overflow-hidden">
              <div id="usage-bar" class="h-full bg-brand-500 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div id="usage-remaining" class="text-sm text-slate-500 mt-2"></div>
          </div>
          <!-- Breakdown -->
          <div>
            <div class="text-xs text-slate-500 uppercase tracking-wider mb-2">Breakdown</div>
            <div class="space-y-1.5">
              <div class="flex items-center justify-between text-sm">
                <span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> Success</span>
                <span id="breakdown-success" class="font-medium text-slate-300">0</span>
              </div>
              <div class="flex items-center justify-between text-sm">
                <span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500"></span> Errors</span>
                <span id="breakdown-error" class="font-medium text-slate-300">0</span>
              </div>
              <div class="flex items-center justify-between text-sm">
                <span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> Rate limited</span>
                <span id="breakdown-ratelimited" class="font-medium text-slate-300">0</span>
              </div>
            </div>
          </div>
          <!-- Avg duration -->
          <div>
            <div class="text-xs text-slate-500 uppercase tracking-wider mb-2">Avg Response</div>
            <div class="flex items-baseline gap-1">
              <span id="avg-duration" class="text-2xl font-bold">0</span>
              <span class="text-sm text-slate-500">ms</span>
            </div>
            <div id="upgrade-cta" class="hidden mt-4">
              <a href="/#pricing" class="text-xs font-medium text-brand-400 hover:underline">Upgrade plan ‚Üí</a>
            </div>
          </div>
        </div>

        <!-- Daily usage bar chart -->
        <div>
          <div class="text-xs text-slate-500 uppercase tracking-wider mb-3">Daily Calls (Last 30 Days)</div>
          <div id="daily-chart" class="flex items-end gap-1 h-24">
            <!-- Bars injected by JS -->
          </div>
        </div>
      </div>
    </section>

    <!-- Top Tools -->
    <section id="tools-section" class="hidden">
      <div class="bg-surface-800 border border-white/5 rounded-2xl p-6 sm:p-8">
        <h2 class="text-lg font-bold mb-4">Top Tools Used</h2>
        <div id="top-tools-list" class="space-y-3">
          <p class="text-sm text-slate-500">No tool calls yet</p>
        </div>
      </div>
    </section>

    <!-- API Keys -->
    <section id="keys-section" class="hidden">
      <div class="bg-surface-800 border border-white/5 rounded-2xl p-6 sm:p-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-bold">API Keys</h2>
          <div class="flex items-center gap-3">
            <span id="keys-count" class="text-sm text-slate-500"></span>
            <button onclick="openCreateKey()" class="px-4 py-2 text-sm font-medium bg-brand-500 hover:bg-brand-600 text-white rounded-lg transition">
              + New Key
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-white/5 text-slate-500 text-xs uppercase tracking-wider">
                <th class="pb-3 text-left font-medium">Key</th>
                <th class="pb-3 text-left font-medium">Name</th>
                <th class="pb-3 text-left font-medium hidden sm:table-cell">Status</th>
                <th class="pb-3 text-left font-medium hidden md:table-cell">Last Used</th>
                <th class="pb-3 text-left font-medium hidden md:table-cell">Created</th>
                <th class="pb-3 text-right font-medium">Actions</th>
              </tr>
            </thead>
            <tbody id="keys-table">
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Google Connection -->
    <section id="google-section" class="hidden">
      <div class="bg-surface-800 border border-white/5 rounded-2xl p-6 sm:p-8">
        <h2 class="text-lg font-bold mb-2">Google Account</h2>
        <p class="text-sm text-slate-400 mb-6">Connect your Google account to use Search Console and Analytics tools.</p>
        <div id="google-status"></div>
      </div>
    </section>

    <!-- Recent Activity -->
    <section id="activity-section" class="hidden">
      <div class="bg-surface-800 border border-white/5 rounded-2xl p-6 sm:p-8">
        <h2 class="text-lg font-bold mb-6">Recent Activity</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-white/5 text-slate-500 text-xs uppercase tracking-wider">
                <th class="pb-3 text-left font-medium">Time</th>
                <th class="pb-3 text-left font-medium">Tool</th>
                <th class="pb-3 text-left font-medium">Status</th>
                <th class="pb-3 text-right font-medium">Duration</th>
              </tr>
            </thead>
            <tbody id="activity-table">
            </tbody>
          </table>
        </div>
        <div id="no-activity" class="hidden text-center py-8">
          <p class="text-slate-500 text-sm">No tool calls yet. Connect your MCP client to get started!</p>
        </div>
      </div>
    </section>

    <!-- Account Settings -->
    <section id="account-section" class="hidden">
      <div class="bg-surface-800 border border-white/5 rounded-2xl p-6 sm:p-8">
        <h2 class="text-lg font-bold mb-6">Account Settings</h2>
        <div class="grid sm:grid-cols-2 gap-8">
          <!-- Info -->
          <div>
            <div class="text-xs text-slate-500 uppercase tracking-wider mb-3">Account Info</div>
            <div class="space-y-3">
              <div>
                <label class="text-xs text-slate-500">Email</label>
                <div id="account-email" class="text-sm text-white font-mono"></div>
              </div>
              <div>
                <label class="text-xs text-slate-500">Plan</label>
                <div id="account-plan" class="text-sm text-white uppercase font-medium"></div>
              </div>
            </div>
          </div>
          <!-- Change Password -->
          <div>
            <div class="text-xs text-slate-500 uppercase tracking-wider mb-3">Change Password</div>
            <form id="password-form" onsubmit="handlePasswordChange(event)" class="space-y-3">
              <input type="password" id="current-password" required placeholder="Current password" autocomplete="current-password"
                class="w-full px-3 py-2 bg-surface-900 border border-white/10 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-brand-500 text-sm">
              <input type="password" id="new-password" required minlength="8" placeholder="New password (min 8)" autocomplete="new-password"
                class="w-full px-3 py-2 bg-surface-900 border border-white/10 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-brand-500 text-sm">
              <div id="password-error" class="hidden text-xs text-red-400"></div>
              <div id="password-success" class="hidden text-xs text-green-400"></div>
              <button type="submit" class="px-4 py-2 text-sm font-medium bg-surface-700 hover:bg-surface-600 text-white rounded-lg border border-white/10 transition">
                Update Password
              </button>
            </form>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Create Key Modal -->
  <div id="create-key-modal" class="modal-overlay">
    <div class="w-full max-w-md mx-4 bg-surface-800 rounded-2xl border border-white/10 shadow-2xl">
      <!-- Step 1: Name -->
      <div id="key-step-1" class="p-8">
        <h3 class="text-lg font-bold mb-1">Create API Key</h3>
        <p class="text-sm text-slate-400 mb-6">Give your key a name to identify it later.</p>
        <form onsubmit="handleCreateKey(event)">
          <input type="text" id="key-name" placeholder="e.g. Claude Desktop, Production" maxlength="50"
            class="w-full px-4 py-2.5 bg-surface-900 border border-white/10 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-brand-500 text-sm mb-4">
          <div id="key-create-error" class="hidden text-sm text-red-400 mb-4"></div>
          <div class="flex gap-3">
            <button type="button" onclick="closeCreateKey()" class="flex-1 py-2.5 text-sm font-medium text-slate-400 bg-surface-700 hover:bg-surface-600 rounded-lg transition">Cancel</button>
            <button type="submit" id="key-create-btn" class="flex-1 py-2.5 text-sm font-semibold bg-brand-500 hover:bg-brand-600 text-white rounded-lg transition">Create Key</button>
          </div>
        </form>
      </div>
      <!-- Step 2: Show Key -->
      <div id="key-step-2" class="hidden p-8">
        <div class="text-center mb-4">
          <span class="text-3xl text-green-400">‚úì</span>
          <h3 class="text-lg font-bold mt-2">Key Created!</h3>
          <p class="text-sm text-amber-400 mt-1">Copy it now ‚Äî it won't be shown again.</p>
        </div>
        <div class="flex items-center gap-2 mb-6">
          <input type="text" id="new-key-display" readonly
            class="flex-1 px-3 py-2 bg-surface-900 border border-white/10 rounded-lg font-mono text-xs text-green-400 select-all">
          <button onclick="copyText(document.getElementById('new-key-display').value)" class="px-4 py-2 bg-brand-500 hover:bg-brand-600 rounded-lg text-sm font-medium text-white shrink-0 transition">Copy</button>
        </div>
        <button onclick="closeCreateKey(); loadDashboard();" class="w-full py-2.5 text-sm font-semibold bg-brand-500 hover:bg-brand-600 text-white rounded-lg transition">Done</button>
      </div>
    </div>
  </div>

  <!-- Revoke Confirm Modal -->
  <div id="revoke-modal" class="modal-overlay">
    <div class="w-full max-w-sm mx-4 p-8 bg-surface-800 rounded-2xl border border-white/10 shadow-2xl">
      <h3 class="text-lg font-bold mb-2">Revoke API Key?</h3>
      <p class="text-sm text-slate-400 mb-2">This will immediately stop any tool using this key:</p>
      <p id="revoke-key-prefix" class="text-sm font-mono text-red-400 mb-6"></p>
      <div class="flex gap-3">
        <button onclick="closeRevokeModal()" class="flex-1 py-2.5 text-sm font-medium text-slate-400 bg-surface-700 hover:bg-surface-600 rounded-lg transition">Cancel</button>
        <button onclick="confirmRevoke()" class="flex-1 py-2.5 text-sm font-semibold bg-red-500 hover:bg-red-600 text-white rounded-lg transition">Revoke</button>
      </div>
    </div>
  </div>

  <!-- Copy Toast -->
  <div id="copy-toast" class="copy-toast">‚úì Copied</div>

  <script>
    // ‚îÄ‚îÄ State ‚îÄ‚îÄ
    let dashData = null;
    let revokeKeyId = null;

    // ‚îÄ‚îÄ Load Dashboard ‚îÄ‚îÄ
    async function loadDashboard() {
      try {
        const res = await fetch('/dashboard/api/overview');
        if (res.status === 401) {
          window.location.href = '/dashboard/login';
          return;
        }
        dashData = await res.json();
        render();
      } catch (err) {
        console.error('Failed to load dashboard:', err);
      }
    }

    // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
    function render() {
      const d = dashData;
      document.getElementById('loading').classList.add('hidden');

      // Nav
      document.getElementById('user-email').textContent = d.user.email;
      document.getElementById('user-email').classList.remove('hidden');
      const badge = document.getElementById('plan-badge');
      badge.textContent = d.user.plan;
      badge.classList.remove('hidden');

      // Quick Start (show if no usage and not dismissed)
      if (d.usage.used === 0 && !localStorage.getItem('qs-dismissed')) {
        const firstKey = d.keys.find(k => k.isActive);
        if (firstKey) {
          document.getElementById('qs-config').textContent = JSON.stringify({
            mcpServers: {
              seo: {
                url: 'https://seomcp.dev/mcp',
                headers: { Authorization: `Bearer ${firstKey.prefix}...` }
              }
            }
          }, null, 2);
          document.getElementById('quickstart').classList.remove('hidden');
        }
      }

      // Usage
      renderUsage(d.usage);

      // Top Tools
      renderTopTools(d.usage.topTools);

      // Keys
      renderKeys(d.keys);

      // Google
      renderGoogle(d.google);

      // Activity
      renderActivity(d.recentCalls);

      // Account
      document.getElementById('account-email').textContent = d.user.email;
      document.getElementById('account-plan').textContent = d.user.plan;
      document.getElementById('account-section').classList.remove('hidden');
    }

    // ‚îÄ‚îÄ Usage ‚îÄ‚îÄ
    function renderUsage(usage) {
      const section = document.getElementById('usage-section');
      section.classList.remove('hidden');

      document.getElementById('usage-used').textContent = usage.used;
      document.getElementById('usage-limit').textContent = usage.limit === 'unlimited' ? '‚àû' : usage.limit;
      document.getElementById('usage-period').textContent = usage.period;

      const pct = usage.limit === 'unlimited' ? 0 : Math.min(100, (usage.used / usage.limit) * 100);
      const bar = document.getElementById('usage-bar');
      bar.style.width = pct + '%';
      if (pct > 80) bar.classList.replace('bg-brand-500', 'bg-amber-500');
      if (pct > 95) bar.classList.replace('bg-amber-500', 'bg-red-500');

      const remaining = usage.remaining === 'unlimited' ? 'Unlimited' : `${usage.remaining} remaining`;
      document.getElementById('usage-remaining').textContent = remaining;

      document.getElementById('breakdown-success').textContent = usage.breakdown.success;
      document.getElementById('breakdown-error').textContent = usage.breakdown.error;
      document.getElementById('breakdown-ratelimited').textContent = usage.breakdown.rateLimited;
      document.getElementById('avg-duration').textContent = usage.avgDurationMs;

      // Show upgrade CTA for free plan
      if (dashData.user.plan === 'free') {
        document.getElementById('upgrade-cta').classList.remove('hidden');
      }

      // Daily chart
      renderDailyChart(usage.dailyUsage);
    }

    function renderDailyChart(daily) {
      const container = document.getElementById('daily-chart');
      container.innerHTML = '';

      if (!daily || daily.length === 0) {
        container.innerHTML = '<span class="text-sm text-slate-600">No data yet</span>';
        return;
      }

      const maxCalls = Math.max(...daily.map(d => d.calls), 1);

      // Fill in missing days for last 30 days
      const today = new Date();
      const days = [];
      for (let i = 29; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const found = daily.find(d => d.date === dateStr);
        days.push({ date: dateStr, calls: found ? found.calls : 0 });
      }

      days.forEach(day => {
        const heightPct = Math.max(2, (day.calls / maxCalls) * 100);
        const bar = document.createElement('div');
        bar.className = 'bar flex-1 rounded-t-sm transition-all duration-300 cursor-pointer';
        bar.style.height = heightPct + '%';
        bar.style.background = day.calls > 0 ? '#0ea5e9' : '#1e293b';
        bar.title = `${day.date}: ${day.calls} calls`;
        container.appendChild(bar);
      });
    }

    // ‚îÄ‚îÄ Top Tools ‚îÄ‚îÄ
    function renderTopTools(tools) {
      const section = document.getElementById('tools-section');
      section.classList.remove('hidden');
      const list = document.getElementById('top-tools-list');

      if (!tools || tools.length === 0) {
        list.innerHTML = '<p class="text-sm text-slate-500">No tool calls yet</p>';
        return;
      }

      const maxCount = Math.max(...tools.map(t => t.count));
      list.innerHTML = tools.map(t => {
        const pct = Math.max(3, (t.count / maxCount) * 100);
        return `<div class="flex items-center gap-4">
          <span class="text-xs font-mono text-slate-300 w-40 shrink-0 truncate">${escHtml(t.tool)}</span>
          <div class="flex-1 h-5 bg-surface-700 rounded-full overflow-hidden">
            <div class="h-full bg-brand-500/60 rounded-full" style="width: ${pct}%"></div>
          </div>
          <span class="text-xs text-slate-400 w-10 text-right">${t.count}</span>
        </div>`;
      }).join('');
    }

    // ‚îÄ‚îÄ API Keys ‚îÄ‚îÄ
    function renderKeys(keys) {
      const section = document.getElementById('keys-section');
      section.classList.remove('hidden');

      const activeCount = keys.filter(k => k.isActive).length;
      const planLimit = { free: 1, pro: 5, agency: 20, enterprise: 999 }[dashData.user.plan] || 1;
      document.getElementById('keys-count').textContent = `${activeCount} / ${planLimit} keys`;

      const tbody = document.getElementById('keys-table');
      if (keys.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-slate-500 text-sm">No API keys yet</td></tr>';
        return;
      }

      tbody.innerHTML = keys.map(k => {
        const statusClass = k.isActive ? 'badge-active' : 'badge-revoked';
        const statusText = k.isActive ? 'Active' : 'Revoked';
        const lastUsed = k.lastUsedAt ? timeAgo(new Date(k.lastUsedAt)) : 'Never';
        const created = new Date(k.createdAt).toLocaleDateString();

        return `<tr class="border-b border-white/5">
          <td class="py-3 pr-4 font-mono text-xs text-slate-300">${escHtml(k.prefix)}...</td>
          <td class="py-3 pr-4 text-slate-300">${escHtml(k.name)}</td>
          <td class="py-3 pr-4 hidden sm:table-cell"><span class="px-2 py-0.5 rounded text-xs font-medium ${statusClass}">${statusText}</span></td>
          <td class="py-3 pr-4 text-slate-500 text-xs hidden md:table-cell">${lastUsed}</td>
          <td class="py-3 pr-4 text-slate-500 text-xs hidden md:table-cell">${created}</td>
          <td class="py-3 text-right">${k.isActive ? `<button onclick="openRevokeModal('${k.id}', '${escHtml(k.prefix)}')" class="text-xs text-red-400 hover:text-red-300 transition">Revoke</button>` : ''}</td>
        </tr>`;
      }).join('');
    }

    // ‚îÄ‚îÄ Google ‚îÄ‚îÄ
    function renderGoogle(google) {
      const section = document.getElementById('google-section');
      section.classList.remove('hidden');
      const statusEl = document.getElementById('google-status');

      if (google.connected) {
        statusEl.innerHTML = `
          <div class="flex items-center justify-between p-4 bg-green-500/5 border border-green-500/20 rounded-xl">
            <div class="flex items-center gap-3">
              <span class="text-2xl">‚úÖ</span>
              <div>
                <div class="text-sm font-medium text-white">${escHtml(google.email || 'Connected')}</div>
                <div class="text-xs text-slate-400">${escHtml(google.scopes || 'GSC + GA4')}</div>
              </div>
            </div>
            <a href="/api/auth/google/disconnect" class="text-xs text-red-400 hover:text-red-300 transition">Disconnect</a>
          </div>`;
      } else {
        statusEl.innerHTML = `
          <div class="flex items-center justify-between p-4 bg-surface-700/50 border border-white/5 rounded-xl">
            <div class="flex items-center gap-3">
              <span class="text-2xl opacity-50">üîó</span>
              <div>
                <div class="text-sm font-medium text-slate-300">Not connected</div>
                <div class="text-xs text-slate-500">Required for Search Console and Analytics tools</div>
              </div>
            </div>
            <a href="/api/auth/google/start" class="px-4 py-2 text-sm font-medium bg-white text-surface-900 rounded-lg hover:bg-slate-100 transition">Connect Google</a>
          </div>`;
      }
    }

    // ‚îÄ‚îÄ Activity ‚îÄ‚îÄ
    function renderActivity(calls) {
      const section = document.getElementById('activity-section');
      section.classList.remove('hidden');
      const tbody = document.getElementById('activity-table');
      const noActivity = document.getElementById('no-activity');

      if (!calls || calls.length === 0) {
        tbody.closest('table').classList.add('hidden');
        noActivity.classList.remove('hidden');
        return;
      }

      noActivity.classList.add('hidden');
      tbody.closest('table').classList.remove('hidden');

      tbody.innerHTML = calls.map(c => {
        const time = timeAgo(new Date(c.createdAt));
        const statusClass = `badge-${c.status}`;
        const duration = c.durationMs ? `${c.durationMs}ms` : '‚Äî';

        return `<tr class="border-b border-white/5">
          <td class="py-2.5 pr-4 text-xs text-slate-500">${time}</td>
          <td class="py-2.5 pr-4 font-mono text-xs text-slate-300">${escHtml(c.tool)}</td>
          <td class="py-2.5 pr-4"><span class="px-2 py-0.5 rounded text-xs font-medium ${statusClass}">${c.status}</span></td>
          <td class="py-2.5 text-right text-xs text-slate-400">${duration}</td>
        </tr>`;
      }).join('');
    }

    // ‚îÄ‚îÄ Key Management ‚îÄ‚îÄ
    function openCreateKey() {
      document.getElementById('create-key-modal').classList.add('active');
      document.getElementById('key-step-1').classList.remove('hidden');
      document.getElementById('key-step-2').classList.add('hidden');
      document.getElementById('key-name').value = '';
      document.getElementById('key-create-error').classList.add('hidden');
      setTimeout(() => document.getElementById('key-name').focus(), 100);
    }

    function closeCreateKey() {
      document.getElementById('create-key-modal').classList.remove('active');
    }

    async function handleCreateKey(e) {
      e.preventDefault();
      const btn = document.getElementById('key-create-btn');
      const errEl = document.getElementById('key-create-error');
      const name = document.getElementById('key-name').value.trim() || 'Untitled';

      btn.textContent = 'Creating...';
      btn.disabled = true;
      errEl.classList.add('hidden');

      try {
        const res = await fetch('/dashboard/api/keys', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name }),
        });
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Failed to create key');
        }

        document.getElementById('new-key-display').value = data.key;
        document.getElementById('key-step-1').classList.add('hidden');
        document.getElementById('key-step-2').classList.remove('hidden');
      } catch (err) {
        errEl.textContent = err.message;
        errEl.classList.remove('hidden');
      } finally {
        btn.textContent = 'Create Key';
        btn.disabled = false;
      }
    }

    function openRevokeModal(keyId, keyPrefix) {
      revokeKeyId = keyId;
      document.getElementById('revoke-key-prefix').textContent = keyPrefix + '...';
      document.getElementById('revoke-modal').classList.add('active');
    }

    function closeRevokeModal() {
      document.getElementById('revoke-modal').classList.remove('active');
      revokeKeyId = null;
    }

    async function confirmRevoke() {
      if (!revokeKeyId) return;
      try {
        const res = await fetch(`/dashboard/api/keys/${revokeKeyId}/revoke`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });
        if (!res.ok) {
          const data = await res.json();
          alert(data.error || 'Failed to revoke key');
          return;
        }
        closeRevokeModal();
        loadDashboard();
      } catch (err) {
        alert('Failed to revoke key');
      }
    }

    // ‚îÄ‚îÄ Password Change ‚îÄ‚îÄ
    async function handlePasswordChange(e) {
      e.preventDefault();
      const errEl = document.getElementById('password-error');
      const successEl = document.getElementById('password-success');
      errEl.classList.add('hidden');
      successEl.classList.add('hidden');

      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;

      try {
        const res = await fetch('/dashboard/api/password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword, newPassword }),
        });
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Failed to update password');
        }

        successEl.textContent = '‚úì Password updated successfully';
        successEl.classList.remove('hidden');
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
      } catch (err) {
        errEl.textContent = err.message;
        errEl.classList.remove('hidden');
      }
    }

    // ‚îÄ‚îÄ Logout ‚îÄ‚îÄ
    async function handleLogout() {
      await fetch('/dashboard/logout', { method: 'POST' });
      window.location.href = '/dashboard/login';
    }

    // ‚îÄ‚îÄ Quick Start ‚îÄ‚îÄ
    function dismissQuickstart() {
      localStorage.setItem('qs-dismissed', '1');
      document.getElementById('quickstart').classList.add('hidden');
    }

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
    function escHtml(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    function timeAgo(date) {
      const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }

    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => {
        const toast = document.getElementById('copy-toast');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
      });
    }

    // ‚îÄ‚îÄ Modal escape/overlay handlers ‚îÄ‚îÄ
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          modal.classList.remove('active');
        }
      });
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
      }
    });

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
    loadDashboard();
  </script>
</body>
</html>
