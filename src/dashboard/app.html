<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard ‚Äî seomcp.dev</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîç</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #0C0C0F;
      --bg-surface: #16161D;
      --bg-raised: #1E1E28;
      --border-subtle: #2A2A36;
      --border-active: #3D3D4E;
      --text-primary: #EDEDF0;
      --text-secondary: #8E8EA0;
      --text-tertiary: #5C5C6E;
      --amber: #E5A430;
      --amber-hover: #F0B840;
      --amber-muted: rgba(229,164,48,0.12);
      --sage: #4ADE80;
      --sage-muted: rgba(74,222,128,0.12);
      --coral: #F87171;
      --blue: #60A5FA;
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
    }
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: var(--font-sans); background: var(--bg-deep);
      color: var(--text-primary); line-height: 1.6; font-size: 14px;
      -webkit-font-smoothing: antialiased;
    }
    a { color: inherit; text-decoration: none; }
    button { font-family: inherit; cursor: pointer; border: none; background: none; }
    code { font-family: var(--font-mono); font-size: 13px; }

    /* Nav */
    .dash-nav {
      position: sticky; top: 0; z-index: 40;
      height: 56px; display: flex; align-items: center;
      background: rgba(12,12,15,0.9); backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border-subtle);
    }
    .dash-nav-inner {
      display: flex; align-items: center; justify-content: space-between;
      max-width: 1120px; width: 100%; margin: 0 auto; padding: 0 24px;
    }
    .dash-logo { font-size: 16px; font-weight: 600; }
    .dash-logo .dot { color: var(--amber); }
    .dash-right { display: flex; align-items: center; gap: 16px; }
    .dash-right a, .dash-right span { font-size: 13px; color: var(--text-tertiary); transition: color 0.2s; }
    .dash-right a:hover { color: var(--text-primary); }
    .plan-badge {
      display: none; padding: 3px 10px; border-radius: 20px;
      font-size: 11px; font-weight: 600; text-transform: uppercase;
      background: var(--amber-muted); color: var(--amber);
      border: 1px solid rgba(229,164,48,0.2);
    }
    .logout-btn { font-size: 13px; color: var(--text-tertiary); transition: color 0.2s; }
    .logout-btn:hover { color: var(--text-primary); }

    /* Content */
    .dash-content { max-width: 1120px; margin: 0 auto; padding: 32px 24px; }
    .dash-content > section { margin-bottom: 24px; }
    .hidden { display: none !important; }

    /* Cards */
    .card {
      background: var(--bg-surface); border: 1px solid var(--border-subtle);
      border-radius: 14px; padding: 28px;
    }
    .card-title { font-size: 17px; font-weight: 600; margin-bottom: 20px; }

    /* Loading skeleton */
    .skeleton {
      border-radius: 14px;
      background: linear-gradient(90deg, var(--bg-surface) 25%, var(--bg-raised) 50%, var(--bg-surface) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* Badges */
    .badge { display: inline-flex; padding: 2px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-active { color: var(--sage); background: var(--sage-muted); border: 1px solid rgba(74,222,128,0.2); }
    .badge-revoked { color: var(--text-tertiary); background: rgba(92,92,110,0.1); border: 1px solid rgba(92,92,110,0.2); }
    .badge-success { color: var(--sage); background: var(--sage-muted); }
    .badge-error { color: var(--coral); background: rgba(248,113,113,0.1); }
    .badge-rate_limited { color: #FBBF24; background: rgba(251,191,36,0.1); }

    /* Status dots */
    .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
    .status-success { background: var(--sage); }
    .status-error { background: var(--coral); }
    .status-rate_limited { background: #FBBF24; }

    /* Buttons */
    .btn-amber {
      padding: 8px 18px; border-radius: 8px;
      background: var(--amber); color: var(--bg-deep);
      font-weight: 600; font-size: 13px;
      transition: background 0.2s;
    }
    .btn-amber:hover { background: var(--amber-hover); }
    .btn-ghost {
      padding: 8px 16px; border-radius: 8px;
      background: var(--bg-raised); color: var(--text-secondary);
      font-size: 13px; font-weight: 500;
      border: 1px solid var(--border-subtle);
      transition: background 0.2s, color 0.2s;
    }
    .btn-ghost:hover { background: var(--border-subtle); color: var(--text-primary); }
    .btn-danger {
      padding: 8px 16px; border-radius: 8px;
      background: rgba(248,113,113,0.1); color: var(--coral);
      font-size: 13px; font-weight: 500;
      border: 1px solid rgba(248,113,113,0.15);
      transition: background 0.2s;
    }
    .btn-danger:hover { background: rgba(248,113,113,0.2); }

    /* Input */
    .input {
      width: 100%; padding: 10px 14px;
      background: var(--bg-deep); border: 1px solid var(--border-subtle);
      border-radius: 8px; color: var(--text-primary);
      font-size: 14px; font-family: var(--font-sans);
      outline: none; transition: border-color 0.2s;
    }
    .input::placeholder { color: var(--text-tertiary); }
    .input:focus { border-color: var(--amber); }
    .input-mono { font-family: var(--font-mono); font-size: 13px; }

    /* Tables */
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 8px 0; font-size: 11px; font-weight: 500; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border-subtle); }
    td { padding: 10px 0; font-size: 13px; border-bottom: 1px solid rgba(42,42,54,0.4); }

    /* Progress bar */
    .progress-track { height: 8px; background: var(--bg-raised); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; background: var(--amber); }
    .progress-fill.warn { background: #FBBF24; }
    .progress-fill.danger { background: var(--coral); }

    /* Bar chart */
    .bar-chart { display: flex; align-items: flex-end; gap: 2px; height: 80px; }
    .bar { flex: 1; min-width: 2px; border-radius: 2px 2px 0 0; transition: height 0.3s ease; cursor: pointer; }

    /* Code block */
    .code-block {
      background: var(--bg-deep); border: 1px solid var(--border-subtle);
      border-radius: 10px; overflow: hidden;
    }
    .code-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 14px; border-bottom: 1px solid var(--border-subtle);
    }
    .code-filename { font-size: 12px; color: var(--text-tertiary); font-family: var(--font-mono); }
    .code-copy-btn { font-size: 11px; color: var(--amber); cursor: pointer; transition: opacity 0.2s; }
    .code-copy-btn:hover { opacity: 0.8; }
    .code-body { padding: 14px; overflow-x: auto; }
    .code-body pre { font-family: var(--font-mono); font-size: 12px; line-height: 20px; color: var(--text-secondary); }

    /* Modals */
    .modal-overlay {
      display: none; position: fixed; inset: 0; z-index: 50;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-card {
      width: 100%; max-width: 440px; margin: 16px;
      background: var(--bg-surface); border: 1px solid var(--border-subtle);
      border-radius: 16px; padding: 32px;
    }

    /* Alert banners */
    .banner-warn {
      display: flex; align-items: center; justify-content: space-between; gap: 16px;
      padding: 16px 20px; border-radius: 12px;
      background: rgba(229,164,48,0.08); border: 1px solid rgba(229,164,48,0.2);
      margin-bottom: 24px;
    }
    .banner-warn-text { font-size: 13px; color: var(--amber); }
    .banner-warn-sub { font-size: 12px; color: var(--text-tertiary); margin-top: 2px; }

    /* Copy toast */
    .copy-toast {
      position: fixed; bottom: 24px; right: 24px; z-index: 100;
      padding: 10px 20px; border-radius: 10px;
      background: var(--sage); color: var(--bg-deep);
      font-weight: 600; font-size: 13px;
      transform: translateY(80px); opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }
    .copy-toast.show { transform: translateY(0); opacity: 1; }

    /* Grids */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

    /* Onboarding */
    .onb-card {
      background: linear-gradient(135deg, rgba(229,164,48,0.06) 0%, rgba(74,222,128,0.03) 100%);
      border: 1px solid rgba(229,164,48,0.15); border-radius: 14px;
      padding: 28px; position: relative;
    }
    .onb-step {
      display: flex; align-items: flex-start; gap: 12px;
      padding: 12px; border-radius: 10px;
      background: rgba(12,12,15,0.4); border: 1px solid rgba(42,42,54,0.4);
    }
    .onb-step.done { opacity: 0.5; }

    /* Agent Cards */
    .agent-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }
    .agent-card:hover { border-color: var(--border-active); }
    .agent-status-badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .status-provisioning { color: var(--amber); background: var(--amber-muted); border: 1px solid rgba(229,164,48,0.2); }
    .status-active { color: var(--sage); background: var(--sage-muted); border: 1px solid rgba(74,222,128,0.2); }
    .status-suspended { color: #FBBF24; background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.2); }
    .status-cancelled { color: var(--text-tertiary); background: rgba(92,92,110,0.1); border: 1px solid rgba(92,92,110,0.2); }

    /* Deploy Wizard */
    .deploy-wizard {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .wizard-step {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 24px;
    }
    .wizard-step.active {
      border-color: var(--amber);
      background: linear-gradient(135deg, rgba(229,164,48,0.03) 0%, transparent 100%);
    }
    .wizard-step.completed {
      border-color: var(--sage);
      background: linear-gradient(135deg, rgba(74,222,128,0.03) 0%, transparent 100%);
    }
    .step-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .step-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }
    .step-number.active {
      background: var(--amber);
      color: var(--bg-deep);
    }
    .step-number.completed {
      background: var(--sage);
      color: var(--bg-deep);
    }
    .step-number.inactive {
      background: var(--bg-raised);
      color: var(--text-tertiary);
      border: 1px solid var(--border-subtle);
    }
    .step-title {
      font-size: 16px;
      font-weight: 600;
    }
    .telegram-instructions {
      background: var(--bg-deep);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
    }
    .telegram-instructions ol {
      margin: 0;
      padding-left: 18px;
      color: var(--text-secondary);
    }
    .telegram-instructions li {
      margin-bottom: 8px;
      font-size: 13px;
    }

    /* Upload Area */
    .upload-area {
      border: 2px dashed var(--border-subtle);
      border-radius: 12px;
      padding: 32px;
      text-align: center;
      background: var(--bg-raised);
      transition: border-color 0.2s, background 0.2s;
      cursor: pointer;
    }
    .upload-area:hover, .upload-area.dragover {
      border-color: var(--amber);
      background: rgba(229,164,48,0.03);
    }
    .upload-area input[type="file"] {
      display: none;
    }
    
    /* Progress Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-subtle);
      border-top: 2px solid var(--amber);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-tertiary);
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.6;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .grid-2, .grid-4 { grid-template-columns: 1fr; }
      .dash-right .hide-mobile { display: none; }
      td.hide-mobile, th.hide-mobile { display: none; }
      .wizard-step { padding: 16px; }
    }
  </style>
</head>
<body>

  <!-- Top Nav -->
  <nav class="dash-nav">
    <div class="dash-nav-inner">
      <a href="/" class="dash-logo">seomcp<span class="dot">.dev</span></a>
      <div class="dash-right">
        <a href="/docs" class="hide-mobile">Docs</a>
        <a href="/tools" class="hide-mobile">Tools</a>
        <span id="plan-badge" class="plan-badge"></span>
        <span id="user-email" class="hide-mobile" style="color:var(--text-tertiary);"></span>
        <button onclick="handleLogout()" class="logout-btn">Logout</button>
      </div>
    </div>
  </nav>

  <main class="dash-content">

    <!-- Loading State -->
    <div id="loading" style="display:flex; flex-direction:column; gap:20px;">
      <div class="skeleton" style="height:120px;"></div>
      <div class="skeleton" style="height:200px;"></div>
      <div class="skeleton" style="height:250px;"></div>
    </div>

    <!-- Email Verification Banner -->
    <div id="verify-banner" class="hidden banner-warn">
      <div>
        <div class="banner-warn-text">üìß Verify your email to unlock full limits</div>
        <div class="banner-warn-sub">Unverified accounts are limited to 10 tool calls/month. Verify to get 50.</div>
      </div>
      <button onclick="resendVerification()" id="resend-btn" class="btn-ghost" style="flex-shrink:0;">Resend Email</button>
    </div>

    <!-- Onboarding Checklist -->
    <section id="onboarding" class="hidden">
      <div class="onb-card">
        <button onclick="dismissOnboarding()" style="position:absolute; top:16px; right:16px; color:var(--text-tertiary); font-size:18px;" title="Dismiss">√ó</button>
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:4px;">
          <span style="font-size:17px; font-weight:600;">üöÄ Getting Started</span>
          <span id="onb-progress" class="badge" style="background:var(--amber-muted); color:var(--amber); border:1px solid rgba(229,164,48,0.2);"></span>
        </div>
        <p style="font-size:13px; color:var(--text-tertiary); margin-bottom:16px;">Complete these steps to get SEO tools in your AI agent.</p>

        <div style="display:flex; flex-direction:column; gap:8px;" id="onb-steps">
          <div id="onb-step-account" class="onb-step">
            <span class="onb-icon" style="font-size:16px;">‚úÖ</span>
            <div>
              <div style="font-size:13px; font-weight:500;">Create account</div>
              <div style="font-size:12px; color:var(--text-tertiary);">You're in! Account created.</div>
            </div>
          </div>
          <div id="onb-step-verify" class="onb-step">
            <span class="onb-icon" style="font-size:16px;">‚è≥</span>
            <div>
              <div style="font-size:13px; font-weight:500;">Verify your email</div>
              <div style="font-size:12px; color:var(--text-tertiary);">Check inbox for the verification link. <button onclick="resendVerification()" style="color:var(--amber); font-size:12px;">Resend</button></div>
            </div>
          </div>
          <div id="onb-step-key" class="onb-step">
            <span class="onb-icon" style="font-size:16px;">‚è≥</span>
            <div style="flex:1; min-width:0;">
              <div style="font-size:13px; font-weight:500;">Add MCP config to your AI tool</div>
              <div style="font-size:12px; color:var(--text-tertiary); margin-bottom:8px;">Copy this into your AI tool's settings:</div>
              <div class="code-block">
                <div class="code-header">
                  <span class="code-filename">mcp.json</span>
                  <span class="code-copy-btn" onclick="copyText(document.getElementById('onb-config').textContent)">Copy</span>
                </div>
                <div class="code-body">
                  <pre id="onb-config"></pre>
                </div>
              </div>
              <div style="font-size:11px; color:var(--text-tertiary); margin-top:6px;">Works with Claude Desktop, Cursor, Windsurf, and any MCP client. <a href="/docs" style="color:var(--amber);">Full setup guide ‚Üí</a></div>
            </div>
          </div>
          <div id="onb-step-google" class="onb-step">
            <span class="onb-icon" style="font-size:16px;">‚è≥</span>
            <div>
              <div style="font-size:13px; font-weight:500;">Connect Google Search Console & Analytics</div>
              <div style="font-size:12px; color:var(--text-tertiary);">Optional but unlocks GSC + GA4 tools (17 of 35 tools).</div>
              <button id="onb-google-btn" onclick="scrollTo('#google-section')" class="btn-ghost" style="margin-top:8px; padding:6px 12px; font-size:12px;">Connect Google ‚Üì</button>
            </div>
          </div>
          <div id="onb-step-usage" class="onb-step">
            <span class="onb-icon" style="font-size:16px;">‚è≥</span>
            <div>
              <div style="font-size:13px; font-weight:500;">Make your first tool call</div>
              <div style="font-size:12px; color:var(--text-tertiary);">Ask your AI: "Run an SEO audit on example.com" or <a href="/playground" style="color:var(--amber);">try the playground</a>.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Usage Overview -->
    <section id="usage-section" class="hidden">
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
          <span class="card-title" style="margin-bottom:0;">Usage This Month</span>
          <span id="usage-period" style="font-size:13px; color:var(--text-tertiary);"></span>
        </div>

        <div class="grid-4" style="margin-bottom:24px;">
          <div style="grid-column:span 2;">
            <div style="display:flex; align-items:baseline; gap:6px; margin-bottom:8px;">
              <span id="usage-used" style="font-size:36px; font-weight:700;"></span>
              <span style="color:var(--text-tertiary);">/</span>
              <span id="usage-limit" style="font-size:22px; color:var(--text-secondary);"></span>
              <span style="font-size:13px; color:var(--text-tertiary);">calls</span>
            </div>
            <div class="progress-track">
              <div id="usage-bar" class="progress-fill" style="width:0%;"></div>
            </div>
            <div id="usage-remaining" style="font-size:13px; color:var(--text-tertiary); margin-top:6px;"></div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:8px;">Breakdown</div>
            <div style="display:flex; flex-direction:column; gap:6px;">
              <div style="display:flex; align-items:center; justify-content:space-between; font-size:13px;">
                <span style="display:flex; align-items:center; gap:6px;"><span class="status-dot status-success"></span> Success</span>
                <span id="breakdown-success" style="font-weight:500;">0</span>
              </div>
              <div style="display:flex; align-items:center; justify-content:space-between; font-size:13px;">
                <span style="display:flex; align-items:center; gap:6px;"><span class="status-dot status-error"></span> Errors</span>
                <span id="breakdown-error" style="font-weight:500;">0</span>
              </div>
              <div style="display:flex; align-items:center; justify-content:space-between; font-size:13px;">
                <span style="display:flex; align-items:center; gap:6px;"><span class="status-dot status-rate_limited"></span> Rate limited</span>
                <span id="breakdown-ratelimited" style="font-weight:500;">0</span>
              </div>
            </div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:8px;">Avg Response</div>
            <div style="display:flex; align-items:baseline; gap:4px;">
              <span id="avg-duration" style="font-size:24px; font-weight:700;">0</span>
              <span style="font-size:13px; color:var(--text-tertiary);">ms</span>
            </div>
            <div id="upgrade-cta" class="hidden" style="margin-top:12px;">
              <a href="/#pricing" style="font-size:12px; color:var(--amber); font-weight:500;">Upgrade plan ‚Üí</a>
            </div>
          </div>
        </div>

        <div>
          <div style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:10px;">Daily Calls (Last 30 Days)</div>
          <div id="daily-chart" class="bar-chart"></div>
        </div>
      </div>
    </section>

    <!-- Top Tools -->
    <section id="tools-section" class="hidden">
      <div class="card">
        <div class="card-title">Top Tools Used</div>
        <div id="top-tools-list">
          <p style="font-size:13px; color:var(--text-tertiary);">No tool calls yet</p>
        </div>
      </div>
    </section>

    <!-- Audit History -->
    <section id="audit-section" class="hidden">
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
          <span class="card-title" style="margin-bottom:0;">Audit History</span>
          <div style="display:flex; align-items:center; gap:12px;">
            <select id="audit-site-filter" onchange="loadAudits()" class="input" style="width:auto; padding:6px 12px; font-size:12px;">
              <option value="">All Sites</option>
            </select>
            <span id="audit-retention" style="font-size:11px; color:var(--text-tertiary);"></span>
          </div>
        </div>

        <div id="health-trend" class="hidden" style="margin-bottom:20px;">
          <div style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:10px;">Health Score Trend</div>
          <div id="trend-chart" class="bar-chart" style="height:64px;"></div>
        </div>

        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Site</th>
                <th>Tool</th>
                <th style="text-align:center;">Score</th>
                <th style="text-align:right;">Duration</th>
              </tr>
            </thead>
            <tbody id="audit-table"></tbody>
          </table>
        </div>
        <div id="no-audits" class="hidden" style="text-align:center; padding:32px;">
          <p style="font-size:13px; color:var(--text-tertiary);">No audits yet. Run <code style="color:var(--amber);">generate_report</code> to get started!</p>
        </div>
      </div>
    </section>

    <!-- API Keys -->
    <section id="keys-section" class="hidden">
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
          <span class="card-title" style="margin-bottom:0;">API Keys</span>
          <div style="display:flex; align-items:center; gap:12px;">
            <span id="keys-count" style="font-size:13px; color:var(--text-tertiary);"></span>
            <button onclick="openCreateKey()" class="btn-amber">+ New Key</button>
          </div>
        </div>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Key</th>
                <th>Name</th>
                <th class="hide-mobile">Status</th>
                <th class="hide-mobile">Last Used</th>
                <th class="hide-mobile">Created</th>
                <th style="text-align:right;">Actions</th>
              </tr>
            </thead>
            <tbody id="keys-table"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Google Connection -->
    <section id="google-section" class="hidden">
      <div class="card">
        <div class="card-title">Google Account</div>
        <p style="font-size:13px; color:var(--text-tertiary); margin-bottom:20px;">Connect your Google account to use Search Console and Analytics tools.</p>
        <div id="google-status"></div>
      </div>
    </section>

    <!-- Billing -->
    <section id="billing-section" class="hidden">
      <div class="card">
        <div class="card-title">Billing</div>
        <div id="billing-status"></div>
      </div>
    </section>

    <!-- Recent Activity -->
    <section id="activity-section" class="hidden">
      <div class="card">
        <div class="card-title">Recent Activity</div>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Tool</th>
                <th>Status</th>
                <th style="text-align:right;">Duration</th>
              </tr>
            </thead>
            <tbody id="activity-table"></tbody>
          </table>
        </div>
        <div id="no-activity" class="hidden" style="text-align:center; padding:32px;">
          <p style="font-size:13px; color:var(--text-tertiary);">No tool calls yet. Connect your MCP client to get started!</p>
        </div>
      </div>
    </section>

    <!-- Scheduled Audits -->
    <section id="schedules-section" class="hidden">
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
          <span class="card-title" style="margin-bottom:0;">Scheduled Audits</span>
          <div style="display:flex; align-items:center; gap:12px;">
            <span id="schedule-limit" style="font-size:11px; color:var(--text-tertiary);"></span>
            <button onclick="showScheduleModal()" id="add-schedule-btn" class="btn-amber" style="font-size:12px; padding:6px 14px;">+ New Schedule</button>
          </div>
        </div>
        <div id="no-schedules" class="hidden" style="text-align:center; padding:40px;">
          <div style="font-size:32px; margin-bottom:8px;">üìÖ</div>
          <p style="font-size:13px; color:var(--text-secondary);">No scheduled audits yet.</p>
          <p style="font-size:12px; color:var(--text-tertiary); margin-top:4px;">Set up automatic SEO monitoring for your sites.</p>
        </div>
        <div id="schedules-list" style="display:flex; flex-direction:column; gap:8px;"></div>
      </div>
    </section>

    <!-- Webhooks -->
    <section id="webhooks-section" class="hidden">
      <div class="card">
        <div class="card-title">Webhooks</div>
        <p style="font-size:13px; color:var(--text-tertiary); margin-bottom:16px;">Get notified when audits complete or usage limits are reached.</p>
        <form onsubmit="saveWebhook(event)" style="display:flex; gap:8px; margin-bottom:16px;">
          <input type="url" id="webhook-url" required placeholder="https://your-server.com/webhook" class="input input-mono" style="flex:1;">
          <button type="submit" class="btn-amber">Save</button>
          <button type="button" onclick="removeWebhook()" class="btn-ghost">Remove</button>
          <button type="button" onclick="testWebhook()" class="btn-ghost">Test</button>
        </form>
        <div id="webhook-error" class="hidden" style="font-size:12px; color:var(--coral); margin-bottom:12px;"></div>
        <div id="webhook-success" class="hidden" style="font-size:12px; color:var(--sage); margin-bottom:12px;"></div>
        <div style="font-size:13px; font-weight:500; color:var(--text-secondary); margin-bottom:10px;">Recent Deliveries</div>
        <div id="no-deliveries" class="hidden" style="text-align:center; padding:20px; font-size:13px; color:var(--text-tertiary);">No deliveries yet.</div>
        <table id="deliveries-table">
          <thead><tr>
            <th>Event</th>
            <th>Status</th>
            <th class="hide-mobile">Duration</th>
            <th>Time</th>
          </tr></thead>
          <tbody id="deliveries-body"></tbody>
        </table>
      </div>
    </section>

    <!-- Agents List -->
    <section id="agents-section" class="hidden">
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
          <span class="card-title" style="margin-bottom:0;">Your SEO Agents</span>
          <button onclick="scrollToSection('deploy-section')" class="btn-amber">Deploy New Agent</button>
        </div>
        <div id="agents-list"></div>
        <div id="no-agents" class="empty-state hidden">
          <div class="empty-state-icon">ü§ñ</div>
          <p style="font-size:16px; margin-bottom:8px; color:var(--text-secondary);">No agents yet</p>
          <p style="font-size:13px; margin-bottom:20px;">Deploy your first SEO agent to get started.</p>
          <button onclick="scrollToSection('deploy-section')" class="btn-amber">Deploy Your First Agent</button>
        </div>
      </div>
    </section>

    <!-- Deploy Agent -->
    <section id="deploy-section" class="hidden">
      <div class="card">
        <div class="card-title">Deploy New SEO Agent</div>
        <div class="deploy-wizard">
          <!-- Step 1: Site URL -->
          <div id="deploy-step-1" class="wizard-step active">
            <div class="step-header">
              <div class="step-number active">1</div>
              <div class="step-title">Site URL</div>
            </div>
            <p style="font-size:13px; color:var(--text-tertiary); margin-bottom:16px;">Enter the website URL you want to monitor with SEO tools.</p>
            <div style="max-width:400px;">
              <input type="url" id="deploy-site-url" placeholder="https://example.com" class="input" style="margin-bottom:12px;">
              <div id="site-url-error" class="hidden" style="font-size:12px; color:var(--coral); margin-bottom:12px;"></div>
              <button onclick="deployStep(2)" class="btn-amber">Next</button>
            </div>
          </div>

          <!-- Step 2: Telegram Bot -->
          <div id="deploy-step-2" class="wizard-step">
            <div class="step-header">
              <div class="step-number inactive">2</div>
              <div class="step-title">Create Telegram Bot</div>
            </div>
            <p style="font-size:13px; color:var(--text-tertiary); margin-bottom:16px;">Create a Telegram bot to receive notifications and interact with your agent.</p>
            <div class="telegram-instructions">
              <p style="font-size:13px; margin-bottom:12px; color:var(--text-secondary);">Follow these steps:</p>
              <ol>
                <li>Open <a href="https://t.me/BotFather" target="_blank" style="color:var(--amber);">@BotFather</a> on Telegram</li>
                <li>Send <code>/newbot</code></li>
                <li>Choose a name (e.g., "My SEO Agent")</li>
                <li>Choose a username ending in <code>bot</code></li>
                <li>Copy the token BotFather gives you</li>
              </ol>
            </div>
            <div style="max-width:400px;">
              <label style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:4px;">Bot Token</label>
              <input type="text" id="deploy-telegram-token" placeholder="1234567890:ABCDEFGHIJKLMNOPQRSTUVWXYZ" class="input input-mono" style="margin-bottom:12px;">
              <div id="telegram-token-error" class="hidden" style="font-size:12px; color:var(--coral); margin-bottom:12px;"></div>
              <div style="display:flex; gap:8px;">
                <button onclick="deployStep(1)" class="btn-ghost">Back</button>
                <button onclick="deployStep(3)" class="btn-amber">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 3: Anthropic API Key -->
          <div id="deploy-step-3" class="wizard-step">
            <div class="step-header">
              <div class="step-number inactive">3</div>
              <div class="step-title">Anthropic API Key</div>
            </div>
            <p style="font-size:13px; color:var(--text-tertiary); margin-bottom:16px;">
              Add your Anthropic API key to power the AI agent. 
              <a href="https://console.anthropic.com/account/keys" target="_blank" style="color:var(--amber);">Get your key here ‚Üí</a>
            </p>
            <div style="max-width:400px;">
              <label style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:4px;">API Key</label>
              <input type="password" id="deploy-anthropic-key" placeholder="sk-ant-..." class="input input-mono" style="margin-bottom:12px;">
              <div id="anthropic-key-error" class="hidden" style="font-size:12px; color:var(--coral); margin-bottom:12px;"></div>
              <div style="display:flex; gap:8px;">
                <button onclick="deployStep(2)" class="btn-ghost">Back</button>
                <button onclick="deployStep(4)" class="btn-amber">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 4: Deploy -->
          <div id="deploy-step-4" class="wizard-step">
            <div class="step-header">
              <div class="step-number inactive">4</div>
              <div class="step-title">Deploy</div>
            </div>
            <div id="deploy-summary" style="background:var(--bg-deep); border:1px solid var(--border-subtle); border-radius:8px; padding:16px; margin-bottom:16px;">
              <div style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:8px;">Deployment Summary</div>
              <div style="display:flex; flex-direction:column; gap:4px; font-size:13px;">
                <div><strong>Site URL:</strong> <span id="summary-site-url">-</span></div>
                <div><strong>Telegram Bot:</strong> <span id="summary-telegram">-</span></div>
                <div><strong>Plan:</strong> <span id="summary-plan">Free</span></div>
              </div>
            </div>
            <div id="deploy-actions">
              <div style="display:flex; gap:8px; margin-bottom:16px;">
                <button onclick="deployStep(3)" class="btn-ghost">Back</button>
                <button onclick="startDeployment()" id="deploy-btn" class="btn-amber" style="font-weight:600;">Deploy Agent</button>
              </div>
            </div>
            <div id="deploy-progress" class="hidden">
              <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
                <div class="spinner"></div>
                <span id="deploy-status">Provisioning agent...</span>
              </div>
              <div id="deploy-logs" style="background:var(--bg-deep); border:1px solid var(--border-subtle); border-radius:8px; padding:12px; max-height:200px; overflow-y:auto; font-family:var(--font-mono); font-size:12px; line-height:1.6;"></div>
            </div>
            <div id="deploy-success" class="hidden" style="text-align:center; padding:20px;">
              <div style="font-size:48px; margin-bottom:16px;">‚úÖ</div>
              <div style="font-size:18px; font-weight:600; margin-bottom:8px;">Agent Deployed Successfully!</div>
              <p style="font-size:13px; color:var(--text-tertiary); margin-bottom:16px;">Your SEO agent is now running and ready to help.</p>
              <a id="telegram-bot-link" href="#" target="_blank" class="btn-amber" style="display:inline-block;">Open Telegram Bot</a>
            </div>
            <div id="deploy-error" class="hidden" style="text-align:center; padding:20px;">
              <div style="font-size:48px; margin-bottom:16px;">‚ùå</div>
              <div style="font-size:18px; font-weight:600; margin-bottom:8px; color:var(--coral);">Deployment Failed</div>
              <p id="deploy-error-message" style="font-size:13px; color:var(--text-tertiary); margin-bottom:16px;"></p>
              <button onclick="retryDeployment()" class="btn-amber">Retry</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Google Credentials -->
    <section id="google-creds-section" class="hidden">
      <div class="card">
        <div class="card-title">Google Credentials</div>
        <p style="font-size:13px; color:var(--text-tertiary); margin-bottom:20px;">
          Upload your Google service account JSON to enable GSC/GA4 data access for your agents.
        </p>
        
        <div id="google-upload-area" style="margin-bottom:24px;">
          <div class="upload-area" onclick="document.getElementById('google-file-input').click();">
            <input type="file" id="google-file-input" accept=".json" onchange="handleGoogleFileSelect(event)">
            <div style="font-size:32px; margin-bottom:12px;">üìÑ</div>
            <div style="font-size:14px; font-weight:500; margin-bottom:4px;">Upload Service Account JSON</div>
            <div style="font-size:12px; color:var(--text-tertiary);">Click to browse or drag and drop</div>
          </div>
          <div style="margin-top:16px;">
            <div style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:6px;">Or Paste JSON</div>
            <textarea id="google-json-text" placeholder="Paste your Google service account JSON here..." class="input" style="min-height:120px; font-family:var(--font-mono); font-size:12px; line-height:1.4; margin-bottom:12px;"></textarea>
            <button onclick="uploadGoogleCredentials()" class="btn-amber">Validate & Upload</button>
          </div>
        </div>

        <div id="google-credentials-list">
          <div style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:10px;">Uploaded Credentials</div>
          <div id="google-creds-empty" class="empty-state">
            <div class="empty-state-icon">üîë</div>
            <p style="font-size:16px; margin-bottom:8px; color:var(--text-secondary);">No credentials uploaded</p>
            <p style="font-size:13px;">Upload your Google service account JSON to enable GSC/GA4 data.</p>
          </div>
          <div id="google-creds-items"></div>
        </div>
      </div>
    </section>

    <!-- Account Settings -->
    <section id="account-section" class="hidden">
      <div class="card">
        <div class="card-title">Account Settings</div>
        <div class="grid-2">
          <div>
            <div style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:10px;">Account Info</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
              <div>
                <div style="font-size:11px; color:var(--text-tertiary);">Email</div>
                <div id="account-email" style="font-size:13px; font-family:var(--font-mono);"></div>
              </div>
              <div>
                <div style="font-size:11px; color:var(--text-tertiary);">Plan</div>
                <div id="account-plan" style="font-size:13px; font-weight:600; text-transform:uppercase;"></div>
              </div>
              <div>
                <div style="font-size:11px; color:var(--text-tertiary);">Agents</div>
                <div id="account-agents" style="font-size:13px; font-weight:500;"></div>
              </div>
            </div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:10px;">Change Password</div>
            <form id="password-form" onsubmit="handlePasswordChange(event)" style="display:flex; flex-direction:column; gap:10px;">
              <input type="password" id="current-password" required placeholder="Current password" autocomplete="current-password" class="input" style="font-size:13px;">
              <input type="password" id="new-password" required minlength="8" placeholder="New password (min 8)" autocomplete="new-password" class="input" style="font-size:13px;">
              <div id="password-error" class="hidden" style="font-size:12px; color:var(--coral);"></div>
              <div id="password-success" class="hidden" style="font-size:12px; color:var(--sage);"></div>
              <button type="submit" class="btn-ghost" style="width:fit-content;">Update Password</button>
            </form>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Create Key Modal -->
  <div id="create-key-modal" class="modal-overlay">
    <div class="modal-card">
      <div id="key-step-1">
        <div style="font-size:17px; font-weight:600; margin-bottom:4px;">Create API Key</div>
        <p style="font-size:13px; color:var(--text-tertiary); margin-bottom:16px;">Give your key a name and optionally restrict which tools it can access.</p>
        <form onsubmit="handleCreateKey(event)">
          <input type="text" id="key-name" placeholder="e.g. Claude Desktop, Production" maxlength="50" class="input" style="margin-bottom:12px;">
          <div style="margin-bottom:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
              <span style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em;">Tool Access</span>
              <button type="button" onclick="toggleScopes()" style="font-size:12px; color:var(--amber);"><span id="scope-toggle-text">Restrict access</span></button>
            </div>
            <div id="scope-options" class="hidden" style="display:grid; grid-template-columns:repeat(3,1fr); gap:6px;">
              <label style="display:flex; align-items:center; gap:6px; padding:8px; background:var(--bg-raised); border-radius:8px; cursor:pointer; font-size:12px; color:var(--text-secondary);">
                <input type="checkbox" name="scope" value="crawl"> Crawl
              </label>
              <label style="display:flex; align-items:center; gap:6px; padding:8px; background:var(--bg-raised); border-radius:8px; cursor:pointer; font-size:12px; color:var(--text-secondary);">
                <input type="checkbox" name="scope" value="gsc"> GSC
              </label>
              <label style="display:flex; align-items:center; gap:6px; padding:8px; background:var(--bg-raised); border-radius:8px; cursor:pointer; font-size:12px; color:var(--text-secondary);">
                <input type="checkbox" name="scope" value="ga4"> GA4
              </label>
              <label style="display:flex; align-items:center; gap:6px; padding:8px; background:var(--bg-raised); border-radius:8px; cursor:pointer; font-size:12px; color:var(--text-secondary);">
                <input type="checkbox" name="scope" value="schema"> Schema
              </label>
              <label style="display:flex; align-items:center; gap:6px; padding:8px; background:var(--bg-raised); border-radius:8px; cursor:pointer; font-size:12px; color:var(--text-secondary);">
                <input type="checkbox" name="scope" value="indexnow"> IndexNow
              </label>
              <label style="display:flex; align-items:center; gap:6px; padding:8px; background:var(--bg-raised); border-radius:8px; cursor:pointer; font-size:12px; color:var(--text-secondary);">
                <input type="checkbox" name="scope" value="report"> Report
              </label>
              <label style="display:flex; align-items:center; gap:6px; padding:8px; background:var(--bg-raised); border-radius:8px; cursor:pointer; font-size:12px; color:var(--text-secondary);">
                <input type="checkbox" name="scope" value="cwv"> CWV
              </label>
              <label style="display:flex; align-items:center; gap:6px; padding:8px; background:var(--bg-raised); border-radius:8px; cursor:pointer; font-size:12px; color:var(--text-secondary);">
                <input type="checkbox" name="scope" value="meta"> Meta
              </label>
            </div>
            <p id="scope-info" style="font-size:11px; color:var(--text-tertiary); margin-top:6px;">All tools accessible (unrestricted)</p>
          </div>
          <div id="key-create-error" class="hidden" style="font-size:13px; color:var(--coral); margin-bottom:12px;"></div>
          <div style="display:flex; gap:10px;">
            <button type="button" onclick="closeCreateKey()" class="btn-ghost" style="flex:1;">Cancel</button>
            <button type="submit" id="key-create-btn" class="btn-amber" style="flex:1;">Create Key</button>
          </div>
        </form>
      </div>
      <div id="key-step-2" class="hidden">
        <div style="text-align:center; margin-bottom:16px;">
          <div style="font-size:28px; color:var(--sage);">‚úì</div>
          <div style="font-size:17px; font-weight:600; margin-top:8px;">Key Created!</div>
          <p style="font-size:13px; color:var(--amber); margin-top:4px;">Copy it now ‚Äî it won't be shown again.</p>
        </div>
        <div style="display:flex; gap:8px; margin-bottom:16px;">
          <input type="text" id="new-key-display" readonly class="input input-mono" style="color:var(--sage);">
          <button onclick="copyText(document.getElementById('new-key-display').value)" class="btn-amber" style="flex-shrink:0;">Copy</button>
        </div>
        <button onclick="closeCreateKey(); loadDashboard();" class="btn-amber" style="width:100%;">Done</button>
      </div>
    </div>
  </div>

  <!-- Revoke Confirm Modal -->
  <div id="revoke-modal" class="modal-overlay">
    <div class="modal-card" style="max-width:380px;">
      <div style="font-size:17px; font-weight:600; margin-bottom:8px;">Revoke API Key?</div>
      <p style="font-size:13px; color:var(--text-tertiary); margin-bottom:8px;">This will immediately stop any tool using this key:</p>
      <p id="revoke-key-prefix" style="font-size:14px; font-family:var(--font-mono); color:var(--coral); margin-bottom:20px;"></p>
      <div style="display:flex; gap:10px;">
        <button onclick="closeRevokeModal()" class="btn-ghost" style="flex:1;">Cancel</button>
        <button onclick="confirmRevoke()" class="btn-danger" style="flex:1;">Revoke</button>
      </div>
    </div>
  </div>

  <!-- Create Schedule Modal -->
  <div id="schedule-modal" class="modal-overlay">
    <div class="modal-card">
      <div style="font-size:17px; font-weight:600; margin-bottom:20px;">New Scheduled Audit</div>
      <form id="schedule-form" onsubmit="createSchedule(event)" style="display:flex; flex-direction:column; gap:12px;">
        <div>
          <label style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:4px;">Site URL</label>
          <input type="text" id="sched-site" required placeholder="example.com" class="input">
        </div>
        <div>
          <label style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:4px;">Tool</label>
          <select id="sched-tool" class="input">
            <option value="generate_report">Full SEO Report (generate_report)</option>
            <option value="site_audit">Site Audit (site_audit)</option>
            <option value="crawl_page">Crawl Page (crawl_page)</option>
          </select>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
          <div>
            <label style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:4px;">Frequency</label>
            <select id="sched-freq" onchange="updateDayField()" class="input">
              <option value="daily">Daily</option>
              <option value="weekly" selected>Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
          <div>
            <label style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:4px;">Hour (UTC)</label>
            <select id="sched-hour" class="input">
              <option value="0">00:00</option><option value="1">01:00</option><option value="2">02:00</option><option value="3">03:00</option><option value="4">04:00</option><option value="5">05:00</option><option value="6" selected>06:00</option><option value="7">07:00</option><option value="8">08:00</option><option value="9">09:00</option><option value="10">10:00</option><option value="11">11:00</option><option value="12">12:00</option><option value="13">13:00</option><option value="14">14:00</option><option value="15">15:00</option><option value="16">16:00</option><option value="17">17:00</option><option value="18">18:00</option><option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option><option value="22">22:00</option><option value="23">23:00</option>
            </select>
          </div>
          <div id="sched-day-wrap">
            <label style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:4px;" id="sched-day-label">Day</label>
            <select id="sched-day" class="input">
              <option value="0">Monday</option><option value="1">Tuesday</option><option value="2">Wednesday</option><option value="3">Thursday</option><option value="4">Friday</option><option value="5">Saturday</option><option value="6">Sunday</option>
            </select>
          </div>
        </div>
        <div id="schedule-error" class="hidden" style="font-size:12px; color:var(--coral);"></div>
        <div style="display:flex; gap:10px; margin-top:4px;">
          <button type="button" onclick="closeScheduleModal()" class="btn-ghost" style="flex:1;">Cancel</button>
          <button type="submit" class="btn-amber" style="flex:1;">Create Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Deprovision Agent Modal -->
  <div id="deprovision-modal" class="modal-overlay">
    <div class="modal-card" style="max-width:400px;">
      <div style="font-size:17px; font-weight:600; margin-bottom:8px; color:var(--coral);">Deprovision Agent?</div>
      <p style="font-size:13px; color:var(--text-tertiary); margin-bottom:8px;">This will permanently delete the agent and all its data:</p>
      <p id="deprovision-agent-url" style="font-size:14px; font-family:var(--font-mono); color:var(--text-secondary); margin-bottom:20px;"></p>
      <p style="font-size:12px; color:var(--coral); margin-bottom:16px;">‚ö†Ô∏è This action cannot be undone.</p>
      <div style="display:flex; gap:10px;">
        <button onclick="closeDeprovisionModal()" class="btn-ghost" style="flex:1;">Cancel</button>
        <button onclick="confirmDeprovision()" class="btn-danger" style="flex:1;">Deprovision</button>
      </div>
    </div>
  </div>

  <!-- Copy Toast -->
  <div id="copy-toast" class="copy-toast">‚úì Copied</div>

  <!-- Lemon Squeezy checkout overlay -->
  <script src="https://app.lemonsqueezy.com/js/lemon.js" defer></script>

  <script>
    // ‚îÄ‚îÄ State ‚îÄ‚îÄ
    let dashData = null;
    let revokeKeyId = null;
    let deprovisionAgentId = null;
    let currentDeployStep = 1;
    let deployData = {};
    let deploymentPollingInterval = null;

    // ‚îÄ‚îÄ Load Dashboard ‚îÄ‚îÄ
    async function loadDashboard() {
      try {
        const res = await fetch('/dashboard/api/overview');
        if (res.status === 401) { window.location.href = '/dashboard/login'; return; }
        dashData = await res.json();
        render();
      } catch (err) { console.error('Failed to load dashboard:', err); }
    }

    // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
    function render() {
      const d = dashData;
      document.getElementById('loading').style.display = 'none';

      document.getElementById('user-email').textContent = d.user.email;
      const badge = document.getElementById('plan-badge');
      badge.textContent = d.user.plan; badge.style.display = '';

      if (!d.user.emailVerified) document.getElementById('verify-banner').classList.remove('hidden');

      renderOnboarding(d);
      renderUsage(d.usage);
      renderTopTools(d.usage.topTools);
      loadAudits();
      renderKeys(d.keys);
      renderGoogle(d.google);
      renderBilling(d.billing, d.user.plan);
      renderActivity(d.recentCalls);
      loadSchedules();
      loadWebhooks();
      loadAgents();
      loadGoogleCredentials();

      document.getElementById('account-email').textContent = d.user.email;
      document.getElementById('account-plan').textContent = d.user.plan;
      
      // Will be updated by loadAgents()
      if (!document.getElementById('account-agents').textContent) {
        document.getElementById('account-agents').textContent = 'Loading...';
      }
      
      document.getElementById('account-section').classList.remove('hidden');
    }

    // ‚îÄ‚îÄ Usage ‚îÄ‚îÄ
    function renderUsage(usage) {
      document.getElementById('usage-section').classList.remove('hidden');
      document.getElementById('usage-used').textContent = usage.used;
      document.getElementById('usage-limit').textContent = usage.limit === 'unlimited' ? '‚àû' : usage.limit;
      document.getElementById('usage-period').textContent = usage.period;

      const pct = usage.limit === 'unlimited' ? 0 : Math.min(100, (usage.used / usage.limit) * 100);
      const bar = document.getElementById('usage-bar');
      bar.style.width = pct + '%';
      bar.className = 'progress-fill' + (pct > 95 ? ' danger' : pct > 80 ? ' warn' : '');

      document.getElementById('usage-remaining').textContent = usage.remaining === 'unlimited' ? 'Unlimited' : usage.remaining + ' remaining';
      document.getElementById('breakdown-success').textContent = usage.breakdown.success;
      document.getElementById('breakdown-error').textContent = usage.breakdown.error;
      document.getElementById('breakdown-ratelimited').textContent = usage.breakdown.rateLimited;
      document.getElementById('avg-duration').textContent = usage.avgDurationMs;

      if (dashData.user.plan === 'free') document.getElementById('upgrade-cta').classList.remove('hidden');
      renderDailyChart(usage.dailyUsage);
    }

    function renderDailyChart(daily) {
      const c = document.getElementById('daily-chart');
      c.innerHTML = '';
      if (!daily || daily.length === 0) { c.innerHTML = '<span style="font-size:13px; color:var(--text-tertiary);">No data yet</span>'; return; }
      const maxCalls = Math.max(...daily.map(d => d.calls), 1);
      const today = new Date(); const days = [];
      for (let i = 29; i >= 0; i--) {
        const date = new Date(today); date.setDate(date.getDate() - i);
        const ds = date.toISOString().split('T')[0];
        const found = daily.find(d => d.date === ds);
        days.push({ date: ds, calls: found ? found.calls : 0 });
      }
      days.forEach(day => {
        const h = Math.max(2, (day.calls / maxCalls) * 100);
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.height = h + '%';
        bar.style.background = day.calls > 0 ? 'var(--amber)' : 'var(--bg-raised)';
        bar.title = day.date + ': ' + day.calls + ' calls';
        c.appendChild(bar);
      });
    }

    // ‚îÄ‚îÄ Top Tools ‚îÄ‚îÄ
    function renderTopTools(tools) {
      document.getElementById('tools-section').classList.remove('hidden');
      const list = document.getElementById('top-tools-list');
      if (!tools || tools.length === 0) { list.innerHTML = '<p style="font-size:13px; color:var(--text-tertiary);">No tool calls yet</p>'; return; }
      const maxCount = Math.max(...tools.map(t => t.count));
      list.innerHTML = tools.map(t => {
        const pct = Math.max(3, (t.count / maxCount) * 100);
        return `<div style="display:flex; align-items:center; gap:12px; margin-bottom:6px;">
          <span style="font-size:12px; font-family:var(--font-mono); color:var(--text-secondary); width:140px; flex-shrink:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escHtml(t.tool)}</span>
          <div style="flex:1; height:18px; background:var(--bg-raised); border-radius:9px; overflow:hidden;">
            <div style="height:100%; width:${pct}%; background:rgba(229,164,48,0.4); border-radius:9px;"></div>
          </div>
          <span style="font-size:12px; color:var(--text-tertiary); width:32px; text-align:right;">${t.count}</span>
        </div>`;
      }).join('');
    }

    // ‚îÄ‚îÄ Audit History ‚îÄ‚îÄ
    async function loadAudits() {
      document.getElementById('audit-section').classList.remove('hidden');
      try {
        const sitesRes = await fetch('/dashboard/api/audits/sites');
        if (sitesRes.ok) {
          const sitesData = await sitesRes.json();
          const sel = document.getElementById('audit-site-filter');
          const cur = sel.value;
          sel.innerHTML = '<option value="">All Sites</option>';
          sitesData.sites.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.siteUrl; opt.textContent = s.siteUrl + ' (' + s.auditCount + ')';
            if (s.siteUrl === cur) opt.selected = true;
            sel.appendChild(opt);
          });
        }
        const siteFilter = document.getElementById('audit-site-filter').value;
        const url = siteFilter ? '/dashboard/api/audits?site_url=' + encodeURIComponent(siteFilter) + '&limit=20' : '/dashboard/api/audits?limit=20';
        const res = await fetch(url);
        if (!res.ok) return;
        const data = await res.json();
        document.getElementById('audit-retention').textContent = data.retention.retentionDays + 'd retention (' + data.retention.plan + ')';
        const tbody = document.getElementById('audit-table');
        const noAudits = document.getElementById('no-audits');
        if (!data.audits || data.audits.length === 0) {
          tbody.closest('table').classList.add('hidden'); noAudits.classList.remove('hidden');
          document.getElementById('health-trend').classList.add('hidden'); return;
        }
        noAudits.classList.add('hidden'); tbody.closest('table').classList.remove('hidden');
        tbody.innerHTML = data.audits.map(a => {
          const d = new Date(a.createdAt);
          const ds = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          const sc = a.healthScore != null
            ? `<span style="padding:2px 8px; border-radius:4px; font-size:12px; font-weight:600; ${a.healthScore >= 80 ? 'color:var(--sage); background:var(--sage-muted);' : a.healthScore >= 60 ? 'color:#FBBF24; background:rgba(251,191,36,0.1);' : 'color:var(--coral); background:rgba(248,113,113,0.1);'}">${a.healthScore}/100</span>`
            : '<span style="color:var(--text-tertiary);">‚Äî</span>';
          const dur = a.durationMs ? (a.durationMs / 1000).toFixed(1) + 's' : '‚Äî';
          return `<tr style="cursor:pointer;" onclick="viewAudit(${a.id})">
            <td style="font-size:12px; color:var(--text-tertiary);">${ds}</td>
            <td style="font-size:12px; font-family:var(--font-mono); color:var(--text-secondary);">${escHtml(a.siteUrl)}</td>
            <td style="font-size:12px; color:var(--text-tertiary);">${escHtml(a.toolName)}</td>
            <td style="text-align:center;">${sc}</td>
            <td style="text-align:right; font-size:12px; color:var(--text-tertiary);">${dur}</td>
          </tr>`;
        }).join('');
        if (siteFilter) loadHealthTrend(siteFilter);
        else document.getElementById('health-trend').classList.add('hidden');
      } catch (err) { console.error('Failed to load audits:', err); }
    }

    async function loadHealthTrend(siteUrl) {
      try {
        const res = await fetch('/dashboard/api/audits/trend?site_url=' + encodeURIComponent(siteUrl) + '&days=30');
        if (!res.ok) return;
        const data = await res.json();
        const c = document.getElementById('trend-chart');
        const s = document.getElementById('health-trend');
        if (!data.dataPoints || data.dataPoints.length === 0) { s.classList.add('hidden'); return; }
        s.classList.remove('hidden'); c.innerHTML = '';
        data.dataPoints.forEach(pt => {
          const bar = document.createElement('div');
          bar.className = 'bar'; bar.style.flex = '1'; bar.style.minWidth = '4px';
          bar.style.height = pt.healthScore + '%';
          bar.style.background = pt.healthScore >= 80 ? 'var(--sage)' : pt.healthScore >= 60 ? '#FBBF24' : 'var(--coral)';
          bar.title = new Date(pt.date).toLocaleDateString() + ': ' + pt.healthScore + '/100';
          c.appendChild(bar);
        });
      } catch { document.getElementById('health-trend').classList.add('hidden'); }
    }

    async function viewAudit(auditId) {
      try {
        const res = await fetch('/dashboard/api/audits/' + auditId);
        if (!res.ok) return;
        const data = await res.json();
        const resultText = typeof data.fullResult === 'object' && data.fullResult.content?.[0]?.text
          ? data.fullResult.content[0].text : JSON.stringify(data.fullResult, null, 2);
        const modal = document.createElement('div');
        modal.className = 'modal-overlay active'; modal.style.display = 'flex';
        modal.innerHTML = `<div style="width:100%; max-width:700px; margin:16px; background:var(--bg-surface); border:1px solid var(--border-subtle); border-radius:16px; max-height:80vh; display:flex; flex-direction:column;">
          <div style="padding:20px 24px; border-bottom:1px solid var(--border-subtle); display:flex; align-items:center; justify-content:space-between; flex-shrink:0;">
            <div>
              <div style="font-size:17px; font-weight:600;">${escHtml(data.toolName)}</div>
              <div style="font-size:12px; color:var(--text-tertiary);">${escHtml(data.siteUrl)} ¬∑ ${new Date(data.createdAt).toLocaleString()}</div>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
              ${data.healthScore != null ? `<span style="padding:4px 12px; border-radius:8px; font-size:14px; font-weight:600; ${data.healthScore >= 80 ? 'color:var(--sage); background:var(--sage-muted);' : 'color:#FBBF24; background:rgba(251,191,36,0.1);'}">${data.healthScore}/100</span>` : ''}
              <button onclick="this.closest('.modal-overlay').remove()" style="color:var(--text-tertiary); font-size:20px; cursor:pointer;">√ó</button>
            </div>
          </div>
          <div style="padding:20px 24px; overflow-y:auto; flex:1;">
            <pre style="font-size:12px; font-family:var(--font-mono); color:var(--text-secondary); white-space:pre-wrap; line-height:1.6;">${escHtml(resultText)}</pre>
          </div>
        </div>`;
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        document.body.appendChild(modal);
      } catch (err) { console.error('Failed to load audit:', err); }
    }

    // ‚îÄ‚îÄ API Keys ‚îÄ‚îÄ
    function renderKeys(keys) {
      document.getElementById('keys-section').classList.remove('hidden');
      const activeCount = keys.filter(k => k.isActive).length;
      const planLimit = { free: 1, pro: 5, agency: 20, enterprise: 999 }[dashData.user.plan] || 1;
      document.getElementById('keys-count').textContent = activeCount + ' / ' + planLimit + ' keys';
      const tbody = document.getElementById('keys-table');
      if (keys.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:24px; color:var(--text-tertiary);">No API keys yet</td></tr>'; return; }
      tbody.innerHTML = keys.map(k => {
        const statusBadge = k.isActive ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-revoked">Revoked</span>';
        const lastUsed = k.lastUsedAt ? timeAgo(new Date(k.lastUsedAt)) : 'Never';
        const created = new Date(k.createdAt).toLocaleDateString();
        const scopeHtml = k.scopes && k.scopes.length > 0
          ? '<div style="display:flex; flex-wrap:wrap; gap:3px; margin-top:4px;">' + k.scopes.map(s => '<span style="padding:1px 6px; font-size:10px; border-radius:4px; background:var(--amber-muted); color:var(--amber); border:1px solid rgba(229,164,48,0.15);">' + escHtml(s) + '</span>').join('') + '</div>'
          : '';
        return `<tr>
          <td style="font-family:var(--font-mono); font-size:12px; color:var(--text-secondary);">${escHtml(k.prefix)}...</td>
          <td><span style="font-size:13px;">${escHtml(k.name)}</span>${scopeHtml}</td>
          <td class="hide-mobile">${statusBadge}</td>
          <td class="hide-mobile" style="font-size:12px; color:var(--text-tertiary);">${lastUsed}</td>
          <td class="hide-mobile" style="font-size:12px; color:var(--text-tertiary);">${created}</td>
          <td style="text-align:right;">${k.isActive ? '<button onclick="openRevokeModal(\'' + k.id + '\', \'' + escHtml(k.prefix) + '\')" style="font-size:12px; color:var(--coral); cursor:pointer;">Revoke</button>' : ''}</td>
        </tr>`;
      }).join('');
    }

    // ‚îÄ‚îÄ Google ‚îÄ‚îÄ
    function renderGoogle(google) {
      document.getElementById('google-section').classList.remove('hidden');
      const el = document.getElementById('google-status');
      if (google.connected) {
        el.innerHTML = `<div style="display:flex; align-items:center; justify-content:space-between; padding:16px; background:var(--sage-muted); border:1px solid rgba(74,222,128,0.2); border-radius:12px;">
          <div style="display:flex; align-items:center; gap:12px;">
            <span style="font-size:20px;">‚úÖ</span>
            <div>
              <div style="font-size:14px; font-weight:500;">${escHtml(google.email || 'Connected')}</div>
              <div style="font-size:12px; color:var(--text-tertiary);">${escHtml(google.scopes || 'GSC + GA4')}</div>
            </div>
          </div>
          <a href="/api/auth/google/disconnect" style="font-size:12px; color:var(--coral);">Disconnect</a>
        </div>`;
      } else {
        el.innerHTML = `<div style="display:flex; align-items:center; justify-content:space-between; padding:16px; background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:12px;">
          <div style="display:flex; align-items:center; gap:12px;">
            <span style="font-size:20px; opacity:0.5;">üîó</span>
            <div>
              <div style="font-size:14px; font-weight:500; color:var(--text-secondary);">Not connected</div>
              <div style="font-size:12px; color:var(--text-tertiary);">Required for Search Console and Analytics tools</div>
            </div>
          </div>
          <a href="/api/auth/google/start" style="padding:8px 16px; font-size:13px; font-weight:500; background:var(--text-primary); color:var(--bg-deep); border-radius:8px;">Connect Google</a>
        </div>`;
      }
    }

    // ‚îÄ‚îÄ Activity ‚îÄ‚îÄ
    function renderActivity(calls) {
      document.getElementById('activity-section').classList.remove('hidden');
      const tbody = document.getElementById('activity-table');
      const noActivity = document.getElementById('no-activity');
      if (!calls || calls.length === 0) { tbody.closest('table').classList.add('hidden'); noActivity.classList.remove('hidden'); return; }
      noActivity.classList.add('hidden'); tbody.closest('table').classList.remove('hidden');
      tbody.innerHTML = calls.map(c => {
        const time = timeAgo(new Date(c.createdAt));
        const dur = c.durationMs ? c.durationMs + 'ms' : '‚Äî';
        return `<tr>
          <td style="font-size:12px; color:var(--text-tertiary);">${time}</td>
          <td style="font-family:var(--font-mono); font-size:12px; color:var(--text-secondary);">${escHtml(c.tool)}</td>
          <td><span class="badge badge-${c.status}">${c.status}</span></td>
          <td style="text-align:right; font-size:12px; color:var(--text-tertiary);">${dur}</td>
        </tr>`;
      }).join('');
    }

    // ‚îÄ‚îÄ Scheduled Audits ‚îÄ‚îÄ
    async function loadSchedules() {
      try {
        const res = await fetch('/dashboard/api/schedules', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        document.getElementById('schedules-section').classList.remove('hidden');
        const limitEl = document.getElementById('schedule-limit');
        const max = data.limits.max === 'unlimited' ? '‚àû' : data.limits.max;
        limitEl.textContent = data.limits.used + '/' + max + ' schedules';
        if (data.limits.max === 0) { document.getElementById('add-schedule-btn').disabled = true; document.getElementById('add-schedule-btn').title = 'Upgrade to Pro'; }
        const list = document.getElementById('schedules-list');
        const noSched = document.getElementById('no-schedules');
        if (data.schedules.length === 0) { noSched.classList.remove('hidden'); list.innerHTML = ''; return; }
        noSched.classList.add('hidden');
        list.innerHTML = data.schedules.map(s => {
          const statusBadge = s.isActive ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-revoked">Paused</span>';
          const nextRun = s.isActive && s.nextRunAt ? new Date(s.nextRunAt).toLocaleString() : '‚Äî';
          const lastRun = s.lastRunAt ? new Date(s.lastRunAt).toLocaleString() : 'Never';
          const error = s.lastError ? '<span style="font-size:11px; color:var(--coral); margin-left:8px;">' + escHtml(s.lastError) + '</span>' : '';
          return `<div style="display:flex; align-items:center; justify-content:space-between; padding:14px; background:var(--bg-deep); border:1px solid var(--border-subtle); border-radius:10px; gap:12px; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px;">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                <span style="font-size:13px; font-weight:500;">${escHtml(s.siteUrl)}</span>
                ${statusBadge}
              </div>
              <div style="font-size:11px; color:var(--text-tertiary);">${escHtml(s.description)} ¬∑ ${s.toolName} ¬∑ ${s.runCount} runs${error}</div>
              <div style="font-size:11px; color:var(--text-tertiary); margin-top:2px;">Next: ${nextRun} ¬∑ Last: ${lastRun}</div>
            </div>
            <div style="display:flex; gap:6px; flex-shrink:0;">
              <button onclick="toggleSchedule('${s.id}', ${!s.isActive})" class="btn-ghost" style="padding:4px 10px; font-size:11px;">${s.isActive ? 'Pause' : 'Resume'}</button>
              <button onclick="runScheduleNow('${s.id}')" class="btn-ghost" style="padding:4px 10px; font-size:11px;" ${!s.isActive ? 'disabled' : ''}>Run Now</button>
              <button onclick="deleteSchedule('${s.id}')" class="btn-danger" style="padding:4px 10px; font-size:11px;">Delete</button>
            </div>
          </div>`;
        }).join('');
      } catch (err) { console.error('Failed to load schedules:', err); }
    }

    function showScheduleModal() { document.getElementById('schedule-modal').classList.add('active'); }
    function closeScheduleModal() { document.getElementById('schedule-modal').classList.remove('active'); }

    function updateDayField() {
      const freq = document.getElementById('sched-freq').value;
      const wrap = document.getElementById('sched-day-wrap');
      const label = document.getElementById('sched-day-label');
      const sel = document.getElementById('sched-day');
      if (freq === 'daily') { wrap.style.display = 'none'; }
      else {
        wrap.style.display = '';
        if (freq === 'weekly') {
          label.textContent = 'Day';
          sel.innerHTML = '<option value="0">Monday</option><option value="1">Tuesday</option><option value="2">Wednesday</option><option value="3">Thursday</option><option value="4">Friday</option><option value="5">Saturday</option><option value="6">Sunday</option>';
        } else {
          label.textContent = 'Day';
          sel.innerHTML = [...Array(28)].map((_, i) => '<option value="' + (i + 1) + '">' + (i + 1) + '</option>').join('');
        }
      }
    }

    async function createSchedule(e) {
      e.preventDefault();
      const errEl = document.getElementById('schedule-error'); errEl.classList.add('hidden');
      const freq = document.getElementById('sched-freq').value;
      const body = { siteUrl: document.getElementById('sched-site').value, toolName: document.getElementById('sched-tool').value, schedule: freq, hour: parseInt(document.getElementById('sched-hour').value) };
      if (freq !== 'daily') body.day = parseInt(document.getElementById('sched-day').value);
      try {
        const res = await fetch('/dashboard/api/schedules', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const data = await res.json();
        if (!res.ok) { errEl.textContent = data.error; errEl.classList.remove('hidden'); return; }
        closeScheduleModal(); document.getElementById('schedule-form').reset(); loadSchedules();
      } catch { errEl.textContent = 'Request failed'; errEl.classList.remove('hidden'); }
    }

    async function toggleSchedule(id, isActive) {
      await fetch('/dashboard/api/schedules/' + id + '/update', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ isActive }) });
      loadSchedules();
    }

    async function runScheduleNow(id) {
      await fetch('/dashboard/api/schedules/' + id + '/run', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
      const toast = document.getElementById('copy-toast');
      toast.textContent = 'üöÄ Audit triggered!'; toast.classList.add('show');
      setTimeout(() => { toast.classList.remove('show'); toast.textContent = '‚úì Copied'; }, 2500);
    }

    async function deleteSchedule(id) {
      if (!confirm('Delete this scheduled audit?')) return;
      await fetch('/dashboard/api/schedules/' + id + '/delete', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
      loadSchedules();
    }

    // ‚îÄ‚îÄ Webhooks ‚îÄ‚îÄ
    async function loadWebhooks() {
      try {
        const res = await fetch('/dashboard/api/webhook', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        document.getElementById('webhooks-section').classList.remove('hidden');
        if (data.webhook.url) document.getElementById('webhook-url').value = data.webhook.url;
        const tbody = document.getElementById('deliveries-body');
        const noD = document.getElementById('no-deliveries');
        const tbl = document.getElementById('deliveries-table');
        if (data.deliveries.length === 0) { noD.classList.remove('hidden'); tbl.classList.add('hidden'); }
        else {
          noD.classList.add('hidden'); tbl.classList.remove('hidden');
          tbody.innerHTML = data.deliveries.map(d => {
            const cls = d.success ? 'color:var(--sage);' : 'color:var(--coral);';
            const st = d.success ? (d.statusCode || 'OK') : (d.error || 'Failed');
            return `<tr><td style="font-size:12px; font-family:var(--font-mono); color:var(--text-secondary);">${escHtml(d.event)}</td><td style="font-size:12px; ${cls}">${escHtml(st)}</td><td class="hide-mobile" style="font-size:12px; color:var(--text-tertiary);">${d.durationMs ? d.durationMs + 'ms' : '‚Äî'}</td><td style="font-size:12px; color:var(--text-tertiary);">${new Date(d.createdAt).toLocaleString()}</td></tr>`;
          }).join('');
        }
      } catch (err) { console.error('Failed to load webhooks:', err); }
    }

    async function saveWebhook(e) {
      e.preventDefault();
      const errEl = document.getElementById('webhook-error'); const sucEl = document.getElementById('webhook-success');
      errEl.classList.add('hidden'); sucEl.classList.add('hidden');
      try {
        const res = await fetch('/dashboard/api/webhook', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: document.getElementById('webhook-url').value }) });
        const data = await res.json();
        if (!res.ok) { errEl.textContent = data.error; errEl.classList.remove('hidden'); return; }
        sucEl.textContent = 'Webhook URL saved ‚úì'; sucEl.classList.remove('hidden');
        setTimeout(() => sucEl.classList.add('hidden'), 3000);
      } catch { errEl.textContent = 'Request failed'; errEl.classList.remove('hidden'); }
    }

    async function removeWebhook() {
      await fetch('/dashboard/api/webhook/remove', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
      document.getElementById('webhook-url').value = '';
      const s = document.getElementById('webhook-success'); s.textContent = 'Webhook removed'; s.classList.remove('hidden');
      setTimeout(() => s.classList.add('hidden'), 3000);
    }

    async function testWebhook() {
      const res = await fetch('/dashboard/api/webhook/test', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
      const data = await res.json();
      if (!res.ok) { document.getElementById('webhook-error').textContent = data.error; document.getElementById('webhook-error').classList.remove('hidden'); return; }
      const s = document.getElementById('webhook-success'); s.textContent = 'Test webhook sent!'; s.classList.remove('hidden');
      setTimeout(() => { s.classList.add('hidden'); loadWebhooks(); }, 2000);
    }

    // ‚îÄ‚îÄ Billing ‚îÄ‚îÄ
    function renderBilling(billing, currentPlan) {
      document.getElementById('billing-section').classList.remove('hidden');
      const el = document.getElementById('billing-status');
      if (!billing && currentPlan === 'free') {
        el.innerHTML = `<p style="font-size:14px; color:var(--text-secondary); margin-bottom:16px;">You're on the <span style="font-weight:500; color:var(--text-primary);">Free</span> plan (50 calls/mo).</p>
          <div class="grid-2">
            <div style="padding:20px; background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:12px;">
              <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span style="font-weight:600;">Pro</span><span style="color:var(--amber); font-weight:700;">$29/mo</span></div>
              <p style="font-size:12px; color:var(--text-tertiary); margin-bottom:12px;">2,000 calls/mo ¬∑ 5 sites ¬∑ 5 API keys</p>
              <button onclick="handleUpgrade('pro')" class="btn-amber" style="width:100%;">Upgrade to Pro</button>
            </div>
            <div style="padding:20px; background:var(--bg-raised); border:1px solid rgba(229,164,48,0.2); border-radius:12px;">
              <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span style="font-weight:600;">Agency</span><span style="color:var(--amber); font-weight:700;">$79/mo</span></div>
              <p style="font-size:12px; color:var(--text-tertiary); margin-bottom:12px;">10,000 calls/mo ¬∑ Unlimited sites ¬∑ 20 keys</p>
              <button onclick="handleUpgrade('agency')" class="btn-amber" style="width:100%;">Upgrade to Agency</button>
            </div>
          </div>`;
      } else if (billing) {
        const isActive = billing.status === 'active' && !billing.cancelAtPeriodEnd;
        const isCancelling = billing.cancelAtPeriodEnd;
        const isPastDue = billing.status === 'past_due';
        const renewDate = billing.renewsAt ? new Date(billing.renewsAt).toLocaleDateString() : 'N/A';
        let html = '';
        if (isPastDue) {
          html += `<div style="padding:16px; background:rgba(248,113,113,0.08); border:1px solid rgba(248,113,113,0.2); border-radius:12px; margin-bottom:12px;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;"><span>‚ö†Ô∏è</span><span style="font-weight:600; color:var(--coral);">Payment Failed</span></div>
            <p style="font-size:13px; color:rgba(248,113,113,0.8);">Please update your payment method to keep access.</p>
            ${billing.updatePaymentUrl ? '<a href="' + escHtml(billing.updatePaymentUrl) + '" target="_blank" class="btn-danger" style="display:inline-block; margin-top:8px;">Update Payment ‚Üí</a>' : ''}
          </div>`;
        }
        if (isCancelling) {
          html += `<div style="padding:16px; background:rgba(229,164,48,0.06); border:1px solid rgba(229,164,48,0.2); border-radius:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div><div style="display:flex; align-items:center; gap:8px; margin-bottom:2px;"><span style="font-weight:600; text-transform:capitalize;">${escHtml(billing.plan)} Plan</span><span class="badge" style="background:rgba(229,164,48,0.1); color:var(--amber); border:1px solid rgba(229,164,48,0.2);">Cancelling</span></div><p style="font-size:13px; color:var(--text-tertiary);">Access until ${renewDate}</p></div>
              <button onclick="handleResume()" class="btn-amber">Resume</button>
            </div>
          </div>`;
        } else if (isActive) {
          html += `<div style="padding:16px; background:var(--sage-muted); border:1px solid rgba(74,222,128,0.2); border-radius:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div><div style="display:flex; align-items:center; gap:8px; margin-bottom:2px;"><span style="font-weight:600; text-transform:capitalize;">${escHtml(billing.plan)} Plan</span><span class="badge badge-active">Active</span></div><p style="font-size:13px; color:var(--text-tertiary);">Renews ${renewDate}</p></div>
              <div style="display:flex; gap:8px;">
                ${billing.portalUrl ? '<a href="' + escHtml(billing.portalUrl) + '" target="_blank" class="btn-ghost" style="font-size:12px;">Manage ‚Üí</a>' : ''}
                <button onclick="handleCancel()" style="font-size:12px; color:var(--coral); padding:8px 12px; border:1px solid rgba(248,113,113,0.15); border-radius:8px; cursor:pointer;">Cancel</button>
              </div>
            </div>
          </div>`;
          if (billing.plan === 'pro') html += `<div style="margin-top:10px; padding:10px 14px; background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:8px; display:flex; justify-content:space-between; align-items:center;"><span style="font-size:13px; color:var(--text-tertiary);">Need more? Agency: 10K calls, unlimited sites</span><button onclick="handleUpgrade('agency')" style="font-size:12px; color:var(--amber); padding:6px 12px; background:var(--amber-muted); border-radius:6px; cursor:pointer;">Upgrade ‚Üí</button></div>`;
        } else {
          html += `<div style="padding:16px; background:var(--bg-raised); border:1px solid var(--border-subtle); border-radius:12px;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;"><span style="font-weight:600; text-transform:capitalize;">${escHtml(billing.plan)} Plan</span><span class="badge badge-revoked">${escHtml(billing.status)}</span></div>
            <p style="font-size:13px; color:var(--text-tertiary); margin-bottom:12px;">Your subscription has ended.</p>
            <button onclick="handleUpgrade('${billing.plan}')" class="btn-amber">Resubscribe</button>
          </div>`;
        }
        el.innerHTML = html;
      }
    }

    async function handleUpgrade(plan) {
      try {
        const res = await fetch('/api/billing/checkout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ plan }) });
        const data = await res.json();
        if (!res.ok) { alert(data.error || 'Failed to create checkout'); return; }
        if (typeof LemonSqueezy !== 'undefined' && LemonSqueezy.Url) LemonSqueezy.Url.Open(data.url);
        else window.open(data.url, '_blank');
      } catch { alert('Failed to start checkout'); }
    }

    async function handleCancel() {
      if (!confirm('Cancel? You\'ll keep access until the end of your billing period.')) return;
      try {
        const res = await fetch('/api/billing/cancel', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
        if (res.ok) loadDashboard(); else { const data = await res.json(); alert(data.error || 'Failed'); }
      } catch { alert('Failed to cancel'); }
    }

    async function handleResume() {
      try {
        const res = await fetch('/api/billing/resume', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
        if (res.ok) loadDashboard(); else { const data = await res.json(); alert(data.error || 'Failed'); }
      } catch { alert('Failed to resume'); }
    }

    // ‚îÄ‚îÄ Key Management ‚îÄ‚îÄ
    function toggleScopes() {
      const opts = document.getElementById('scope-options');
      const txt = document.getElementById('scope-toggle-text');
      if (opts.classList.contains('hidden')) { opts.classList.remove('hidden'); opts.style.display = 'grid'; txt.textContent = 'Allow all tools'; }
      else { opts.classList.add('hidden'); opts.style.display = ''; document.querySelectorAll('input[name="scope"]').forEach(cb => cb.checked = false); document.getElementById('scope-info').textContent = 'All tools accessible (unrestricted)'; txt.textContent = 'Restrict access'; }
    }

    document.addEventListener('change', (e) => {
      if (e.target.name === 'scope') {
        const checked = Array.from(document.querySelectorAll('input[name="scope"]:checked')).map(cb => cb.value);
        document.getElementById('scope-info').textContent = checked.length === 0 ? 'All tools accessible (unrestricted)' : 'Restricted to: ' + checked.join(', ');
      }
    });

    function openCreateKey() {
      document.getElementById('create-key-modal').classList.add('active');
      document.getElementById('key-step-1').classList.remove('hidden'); document.getElementById('key-step-1').style.display = '';
      document.getElementById('key-step-2').classList.add('hidden');
      document.getElementById('key-name').value = ''; document.getElementById('key-create-error').classList.add('hidden');
      document.getElementById('scope-options').classList.add('hidden'); document.getElementById('scope-options').style.display = '';
      document.getElementById('scope-toggle-text').textContent = 'Restrict access';
      document.getElementById('scope-info').textContent = 'All tools accessible (unrestricted)';
      document.querySelectorAll('input[name="scope"]').forEach(cb => cb.checked = false);
      setTimeout(() => document.getElementById('key-name').focus(), 100);
    }

    function closeCreateKey() { document.getElementById('create-key-modal').classList.remove('active'); }

    async function handleCreateKey(e) {
      e.preventDefault();
      const btn = document.getElementById('key-create-btn'); const errEl = document.getElementById('key-create-error');
      const name = document.getElementById('key-name').value.trim() || 'Untitled';
      const checkedScopes = Array.from(document.querySelectorAll('input[name="scope"]:checked')).map(cb => cb.value);
      const scopes = checkedScopes.length > 0 ? checkedScopes : undefined;
      btn.textContent = 'Creating...'; btn.disabled = true; errEl.classList.add('hidden');
      try {
        const res = await fetch('/dashboard/api/keys', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, scopes }) });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        document.getElementById('new-key-display').value = data.key;
        document.getElementById('key-step-1').classList.add('hidden');
        document.getElementById('key-step-2').classList.remove('hidden');
      } catch (err) { errEl.textContent = err.message; errEl.classList.remove('hidden'); }
      finally { btn.textContent = 'Create Key'; btn.disabled = false; }
    }

    function openRevokeModal(keyId, keyPrefix) {
      revokeKeyId = keyId;
      document.getElementById('revoke-key-prefix').textContent = keyPrefix + '...';
      document.getElementById('revoke-modal').classList.add('active');
    }
    function closeRevokeModal() { document.getElementById('revoke-modal').classList.remove('active'); revokeKeyId = null; }

    async function confirmRevoke() {
      if (!revokeKeyId) return;
      try {
        const res = await fetch('/dashboard/api/keys/' + revokeKeyId + '/revoke', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
        if (!res.ok) { const data = await res.json(); alert(data.error || 'Failed'); return; }
        closeRevokeModal(); loadDashboard();
      } catch { alert('Failed to revoke key'); }
    }

    // ‚îÄ‚îÄ Password ‚îÄ‚îÄ
    async function handlePasswordChange(e) {
      e.preventDefault();
      const errEl = document.getElementById('password-error'); const sucEl = document.getElementById('password-success');
      errEl.classList.add('hidden'); sucEl.classList.add('hidden');
      try {
        const res = await fetch('/dashboard/api/password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ currentPassword: document.getElementById('current-password').value, newPassword: document.getElementById('new-password').value }) });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        sucEl.textContent = '‚úì Password updated'; sucEl.classList.remove('hidden');
        document.getElementById('current-password').value = ''; document.getElementById('new-password').value = '';
      } catch (err) { errEl.textContent = err.message; errEl.classList.remove('hidden'); }
    }

    // ‚îÄ‚îÄ Logout ‚îÄ‚îÄ
    async function handleLogout() { await fetch('/dashboard/logout', { method: 'POST' }); window.location.href = '/dashboard/login'; }

    // ‚îÄ‚îÄ Onboarding ‚îÄ‚îÄ
    function renderOnboarding(d) {
      if (localStorage.getItem('onboarding-dismissed')) return;
      const steps = { account: true, verify: d.user.emailVerified === true, key: true, google: d.google.connected === true, usage: d.usage.used > 0 };
      const completed = Object.values(steps).filter(Boolean).length;
      const total = Object.keys(steps).length;
      if (completed === total) { localStorage.setItem('onboarding-dismissed', '1'); return; }
      document.getElementById('onb-progress').textContent = completed + '/' + total + ' complete';
      for (const [step, done] of Object.entries(steps)) {
        const el = document.getElementById('onb-step-' + step);
        if (!el) continue;
        const icon = el.querySelector('.onb-icon');
        if (done) { icon.textContent = '‚úÖ'; el.classList.add('done'); } else { icon.textContent = '‚¨ú'; }
      }
      const firstKey = d.keys.find(k => k.isActive);
      if (firstKey) {
        document.getElementById('onb-config').textContent = JSON.stringify({ mcpServers: { seo: { url: 'https://seomcp.dev/mcp', headers: { Authorization: 'Bearer ' + firstKey.prefix + '...' } } } }, null, 2);
      }
      if (steps.google) { const btn = document.getElementById('onb-google-btn'); if (btn) btn.style.display = 'none'; }
      document.getElementById('onboarding').classList.remove('hidden');
    }

    function dismissOnboarding() { localStorage.setItem('onboarding-dismissed', '1'); document.getElementById('onboarding').classList.add('hidden'); }
    function scrollTo(sel) { const el = document.querySelector(sel); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }

    async function resendVerification() {
      const btn = document.getElementById('resend-btn');
      btn.disabled = true; btn.textContent = 'Sending...';
      try {
        const res = await fetch('/api/auth/resend-verification', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: dashData.user.email }) });
        if (res.ok) { btn.textContent = '‚úì Sent!'; setTimeout(() => { btn.textContent = 'Resend Email'; btn.disabled = false; }, 5000); }
        else { const data = await res.json(); btn.textContent = data.error || 'Failed'; setTimeout(() => { btn.textContent = 'Resend Email'; btn.disabled = false; }, 3000); }
      } catch { btn.textContent = 'Error'; setTimeout(() => { btn.textContent = 'Resend Email'; btn.disabled = false; }, 3000); }
    }

    // ‚îÄ‚îÄ Agents ‚îÄ‚îÄ
    async function loadAgents() {
      try {
        const res = await fetch('/dashboard/api/agents');
        if (!res.ok) return;
        const data = await res.json();
        
        document.getElementById('agents-section').classList.remove('hidden');
        const agentsList = document.getElementById('agents-list');
        const noAgents = document.getElementById('no-agents');
        
        // Update account section with agent count
        const agentCountEl = document.getElementById('account-agents');
        if (agentCountEl) {
          agentCountEl.textContent = `${data.agents.length} active`;
        }
        
        if (!data.agents || data.agents.length === 0) {
          agentsList.innerHTML = '';
          noAgents.classList.remove('hidden');
          return;
        }
        
        noAgents.classList.add('hidden');
        agentsList.innerHTML = data.agents.map(agent => {
          const statusClass = `status-${agent.status}`;
          const createdDate = new Date(agent.createdAt).toLocaleDateString();
          const hasApiKeyIndicator = agent.hasApiKey 
            ? '<span style="color:var(--sage); font-size:12px;">üîë</span>' 
            : '<span style="color:var(--text-tertiary); font-size:12px;">üîë</span>';
          
          return `<div class="agent-card">
            <div style="display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:12px;">
              <div style="flex:1;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
                  <span style="font-size:15px; font-weight:600;">${escHtml(agent.siteUrl)}</span>
                  <span class="agent-status-badge ${statusClass}">${agent.status}</span>
                  ${hasApiKeyIndicator}
                </div>
                <div style="font-size:12px; color:var(--text-tertiary);">
                  Plan: ${escHtml(agent.plan || 'Free')} ‚Ä¢ Created: ${createdDate}
                </div>
              </div>
              <div style="display:flex; gap:8px; flex-shrink:0;">
                <button onclick="viewAgentDetails('${agent.id}')" class="btn-ghost" style="font-size:12px; padding:6px 12px;">View Details</button>
                <button onclick="openDeprovisionModal('${agent.id}', '${escHtml(agent.siteUrl)}')" class="btn-danger" style="font-size:12px; padding:6px 12px;">Deprovision</button>
              </div>
            </div>
          </div>`;
        }).join('');
      } catch (err) {
        console.error('Failed to load agents:', err);
      }
    }

    async function viewAgentDetails(agentId) {
      try {
        const res = await fetch(`/dashboard/api/agents/${agentId}`);
        if (!res.ok) return;
        const agent = await res.json();
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay active';
        modal.style.display = 'flex';
        modal.innerHTML = `<div class="modal-card" style="max-width:600px;">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
            <div>
              <div style="font-size:17px; font-weight:600;">${escHtml(agent.siteUrl)}</div>
              <div style="font-size:12px; color:var(--text-tertiary);">Agent Details</div>
            </div>
            <button onclick="this.closest('.modal-overlay').remove()" style="color:var(--text-tertiary); font-size:20px;">√ó</button>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
            <div>
              <div style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; margin-bottom:8px;">Status</div>
              <span class="agent-status-badge status-${agent.status}">${agent.status}</span>
            </div>
            <div>
              <div style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; margin-bottom:8px;">Plan</div>
              <div style="font-size:13px;">${escHtml(agent.plan || 'Free')}</div>
            </div>
            <div>
              <div style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; margin-bottom:8px;">Created</div>
              <div style="font-size:13px;">${new Date(agent.createdAt).toLocaleString()}</div>
            </div>
            <div>
              <div style="font-size:11px; color:var(--text-tertiary); text-transform:uppercase; margin-bottom:8px;">API Key</div>
              <div style="font-size:13px;">${agent.hasApiKey ? '‚úÖ Configured' : '‚ùå Missing'}</div>
            </div>
          </div>
        </div>`;
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        document.body.appendChild(modal);
      } catch (err) {
        console.error('Failed to load agent details:', err);
      }
    }

    function openDeprovisionModal(agentId, siteUrl) {
      deprovisionAgentId = agentId;
      document.getElementById('deprovision-agent-url').textContent = siteUrl;
      document.getElementById('deprovision-modal').classList.add('active');
    }

    function closeDeprovisionModal() {
      document.getElementById('deprovision-modal').classList.remove('active');
      deprovisionAgentId = null;
    }

    async function confirmDeprovision() {
      if (!deprovisionAgentId) return;
      try {
        const res = await fetch(`/dashboard/api/agents/${deprovisionAgentId}/deprovision`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        if (!res.ok) {
          const data = await res.json();
          alert(data.error || 'Failed to deprovision agent');
          return;
        }
        closeDeprovisionModal();
        loadAgents();
        showToast('Agent deprovisioned successfully');
      } catch (err) {
        alert('Failed to deprovision agent');
      }
    }

    // ‚îÄ‚îÄ Deploy Wizard ‚îÄ‚îÄ
    function deployStep(step) {
      if (step === 2 && !validateSiteUrl()) return;
      if (step === 3 && !validateTelegramToken()) return;
      if (step === 4 && !validateAnthropicKey()) return;
      
      // Hide all steps
      for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById(`deploy-step-${i}`);
        const numberEl = stepEl.querySelector('.step-number');
        stepEl.classList.remove('active', 'completed');
        numberEl.classList.remove('active', 'completed');
        numberEl.classList.add('inactive');
      }
      
      // Show current and mark previous as completed
      for (let i = 1; i <= step; i++) {
        const stepEl = document.getElementById(`deploy-step-${i}`);
        const numberEl = stepEl.querySelector('.step-number');
        numberEl.classList.remove('inactive');
        if (i < step) {
          stepEl.classList.add('completed');
          numberEl.classList.add('completed');
        } else {
          stepEl.classList.add('active');
          numberEl.classList.add('active');
        }
      }
      
      currentDeployStep = step;
      
      if (step === 4) {
        updateDeploySummary();
      }
    }

    function validateSiteUrl() {
      const url = document.getElementById('deploy-site-url').value.trim();
      const errorEl = document.getElementById('site-url-error');
      
      if (!url) {
        errorEl.textContent = 'Please enter a website URL';
        errorEl.classList.remove('hidden');
        return false;
      }
      
      try {
        new URL(url.startsWith('http') ? url : 'https://' + url);
        deployData.siteUrl = url;
        errorEl.classList.add('hidden');
        return true;
      } catch {
        errorEl.textContent = 'Please enter a valid URL (e.g., https://example.com)';
        errorEl.classList.remove('hidden');
        return false;
      }
    }

    function validateTelegramToken() {
      const token = document.getElementById('deploy-telegram-token').value.trim();
      const errorEl = document.getElementById('telegram-token-error');
      
      if (!token) {
        errorEl.textContent = 'Please enter your Telegram bot token';
        errorEl.classList.remove('hidden');
        return false;
      }
      
      // Basic telegram token format: digits:alphanumeric
      if (!/^\d+:[A-Za-z0-9_-]+$/.test(token)) {
        errorEl.textContent = 'Invalid token format. Should be like: 1234567890:ABCDEFGHIJKLMNOP';
        errorEl.classList.remove('hidden');
        return false;
      }
      
      deployData.telegramToken = token;
      errorEl.classList.add('hidden');
      return true;
    }

    function validateAnthropicKey() {
      const key = document.getElementById('deploy-anthropic-key').value.trim();
      const errorEl = document.getElementById('anthropic-key-error');
      
      if (!key) {
        errorEl.textContent = 'Please enter your Anthropic API key';
        errorEl.classList.remove('hidden');
        return false;
      }
      
      if (!key.startsWith('sk-ant-')) {
        errorEl.textContent = 'API key should start with sk-ant-';
        errorEl.classList.remove('hidden');
        return false;
      }
      
      deployData.anthropicKey = key;
      errorEl.classList.add('hidden');
      return true;
    }

    function updateDeploySummary() {
      document.getElementById('summary-site-url').textContent = deployData.siteUrl || '-';
      document.getElementById('summary-telegram').textContent = deployData.telegramToken ? 'Configured' : '-';
      document.getElementById('summary-plan').textContent = dashData?.user?.plan || 'Free';
    }

    async function startDeployment() {
      document.getElementById('deploy-actions').classList.add('hidden');
      document.getElementById('deploy-progress').classList.remove('hidden');
      document.getElementById('deploy-success').classList.add('hidden');
      document.getElementById('deploy-error').classList.add('hidden');
      
      try {
        // Step 1: Provision agent
        updateDeployStatus('Provisioning agent...');
        const provisionRes = await fetch('/dashboard/api/agents/provision', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            site_url: deployData.siteUrl,
            telegram_token: deployData.telegramToken
          })
        });
        
        if (!provisionRes.ok) {
          const error = await provisionRes.json();
          throw new Error(error.error || 'Provisioning failed');
        }
        
        const provisionData = await provisionRes.json();
        addDeployLog(`‚úÖ Agent provisioned: ${provisionData.agentId}`);
        
        // Step 2: Deploy to Hetzner
        updateDeployStatus('Deploying to server...');
        const deployRes = await fetch('/dashboard/api/agents/deploy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            agent_id: provisionData.agentId,
            anthropic_api_key: deployData.anthropicKey,
            site_url: deployData.siteUrl,
            telegram_token: deployData.telegramToken
          })
        });
        
        if (!deployRes.ok) {
          const error = await deployRes.json();
          throw new Error(error.error || 'Deployment failed');
        }
        
        const deployResult = await deployRes.json();
        addDeployLog(`üöÄ Deploying to server: ${deployResult.serverId}`);
        
        // Step 3: Poll for completion
        updateDeployStatus('Starting agent...');
        pollDeploymentStatus(deployResult.serverId);
        
      } catch (err) {
        showDeployError(err.message);
      }
    }

    function pollDeploymentStatus(serverId) {
      let attempts = 0;
      const maxAttempts = 60; // 5 minutes
      
      deploymentPollingInterval = setInterval(async () => {
        attempts++;
        
        try {
          const res = await fetch(`/dashboard/api/agents/deploy/${serverId}/verify`);
          if (!res.ok) {
            if (attempts >= maxAttempts) {
              clearInterval(deploymentPollingInterval);
              showDeployError('Deployment timeout - please check manually');
            }
            return;
          }
          
          const status = await res.json();
          
          if (status.status === 'running') {
            clearInterval(deploymentPollingInterval);
            addDeployLog('‚úÖ Agent is running and ready!');
            showDeploySuccess(deployData.telegramToken);
          } else if (status.status === 'failed') {
            clearInterval(deploymentPollingInterval);
            showDeployError(status.error || 'Deployment failed');
          } else {
            // Still starting
            addDeployLog(`‚è≥ Status: ${status.status}...`);
          }
          
        } catch (err) {
          if (attempts >= maxAttempts) {
            clearInterval(deploymentPollingInterval);
            showDeployError('Connection error during verification');
          }
        }
      }, 5000);
    }

    function updateDeployStatus(message) {
      document.getElementById('deploy-status').textContent = message;
    }

    function addDeployLog(message) {
      const logs = document.getElementById('deploy-logs');
      const timestamp = new Date().toLocaleTimeString();
      logs.innerHTML += `<div style="color:var(--text-tertiary);">[${timestamp}] ${message}</div>`;
      logs.scrollTop = logs.scrollHeight;
    }

    function showDeploySuccess(telegramToken) {
      document.getElementById('deploy-progress').classList.add('hidden');
      document.getElementById('deploy-success').classList.remove('hidden');
      
      // Extract bot username from token for Telegram link
      const botId = telegramToken.split(':')[0];
      document.getElementById('telegram-bot-link').href = `https://t.me/bot${botId}`;
      
      // Clear sensitive data from memory after success
      deployData = {};
      
      // Refresh agents list
      setTimeout(() => {
        loadAgents();
        resetDeployWizard();
      }, 3000);
    }

    function showDeployError(message) {
      document.getElementById('deploy-progress').classList.add('hidden');
      document.getElementById('deploy-error').classList.remove('hidden');
      document.getElementById('deploy-error-message').textContent = message;
    }

    function retryDeployment() {
      document.getElementById('deploy-error').classList.add('hidden');
      document.getElementById('deploy-actions').classList.remove('hidden');
    }

    function resetDeployWizard() {
      currentDeployStep = 1;
      deployData = {};
      document.getElementById('deploy-site-url').value = '';
      document.getElementById('deploy-telegram-token').value = '';
      document.getElementById('deploy-anthropic-key').value = '';
      document.getElementById('deploy-logs').innerHTML = '';
      
      // Reset to step 1
      deployStep(1);
      
      document.getElementById('deploy-actions').classList.remove('hidden');
      document.getElementById('deploy-progress').classList.add('hidden');
      document.getElementById('deploy-success').classList.add('hidden');
      document.getElementById('deploy-error').classList.add('hidden');
    }

    // ‚îÄ‚îÄ Google Credentials ‚îÄ‚îÄ
    async function loadGoogleCredentials() {
      try {
        const res = await fetch('/dashboard/api/google/credentials');
        if (!res.ok) return;
        
        const data = await res.json();
        document.getElementById('google-creds-section').classList.remove('hidden');
        
        const emptyEl = document.getElementById('google-creds-empty');
        const itemsEl = document.getElementById('google-creds-items');
        
        if (!data.credentials || data.credentials.length === 0) {
          emptyEl.classList.remove('hidden');
          itemsEl.innerHTML = '';
          return;
        }
        
        emptyEl.classList.add('hidden');
        itemsEl.innerHTML = data.credentials.map(cred => {
          const statusBadge = cred.status === 'active' 
            ? '<span class="badge badge-active">Active</span>'
            : '<span class="badge badge-error">Invalid</span>';
          
          const properties = cred.discoveredProperties 
            ? cred.discoveredProperties.map(p => `<span style="font-size:11px; padding:2px 6px; background:var(--bg-deep); border:1px solid var(--border-subtle); border-radius:4px;">${escHtml(p)}</span>`).join(' ')
            : '';
          
          return `<div style="display:flex; align-items:center; justify-content:between; padding:16px; background:var(--bg-deep); border:1px solid var(--border-subtle); border-radius:10px; margin-bottom:12px;">
            <div style="flex:1;">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                <span style="font-size:13px; font-weight:500;">${escHtml(cred.email || 'Unknown')}</span>
                ${statusBadge}
              </div>
              <div style="font-size:12px; color:var(--text-tertiary); margin-bottom:6px;">
                Uploaded: ${new Date(cred.createdAt).toLocaleDateString()}
              </div>
              <div style="display:flex; gap:4px; flex-wrap:wrap;">${properties}</div>
            </div>
            <div style="display:flex; gap:8px; flex-shrink:0;">
              <button onclick="testGoogleCredential('${cred.id}')" class="btn-ghost" style="font-size:12px; padding:6px 12px;">Test</button>
              <button onclick="removeGoogleCredential('${cred.id}')" class="btn-danger" style="font-size:12px; padding:6px 12px;">Remove</button>
            </div>
          </div>`;
        }).join('');
      } catch (err) {
        console.error('Failed to load Google credentials:', err);
      }
    }

    function handleGoogleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const json = JSON.parse(e.target.result);
          document.getElementById('google-json-text').value = JSON.stringify(json, null, 2);
        } catch (err) {
          alert('Invalid JSON file');
        }
      };
      reader.readAsText(file);
    }

    async function uploadGoogleCredentials() {
      const jsonText = document.getElementById('google-json-text').value.trim();
      if (!jsonText) {
        alert('Please provide the JSON credentials');
        return;
      }
      
      try {
        JSON.parse(jsonText); // Validate JSON
      } catch {
        alert('Invalid JSON format');
        return;
      }
      
      try {
        const res = await fetch('/dashboard/api/google/upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ credentials: jsonText })
        });
        
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || 'Upload failed');
          return;
        }
        
        document.getElementById('google-json-text').value = '';
        document.getElementById('google-file-input').value = '';
        loadGoogleCredentials();
        showToast('Google credentials uploaded successfully');
        
      } catch (err) {
        alert('Upload failed');
      }
    }

    async function testGoogleCredential(credId) {
      try {
        const res = await fetch(`/dashboard/api/google/credentials/${credId}/validate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || 'Validation failed');
          return;
        }
        
        showToast('Google credentials are valid ‚úÖ');
        loadGoogleCredentials();
        
      } catch (err) {
        alert('Validation failed');
      }
    }

    async function removeGoogleCredential(credId) {
      if (!confirm('Remove this Google credential? This cannot be undone.')) return;
      
      try {
        const res = await fetch(`/dashboard/api/google/credentials/${credId}`, {
          method: 'DELETE'
        });
        
        if (!res.ok) {
          const data = await res.json();
          alert(data.error || 'Remove failed');
          return;
        }
        
        loadGoogleCredentials();
        showToast('Google credential removed');
        
      } catch (err) {
        alert('Remove failed');
      }
    }

    // ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
    function scrollToSection(sectionId) {
      const element = document.getElementById(sectionId);
      if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Show deploy section if hidden
        if (sectionId === 'deploy-section') {
          element.classList.remove('hidden');
        }
      }
    }

    function showToast(message) {
      const toast = document.getElementById('copy-toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
        toast.textContent = '‚úì Copied';
      }, 2500);
    }

    // Show deploy section by default
    document.getElementById('deploy-section').classList.remove('hidden');

    // ‚îÄ‚îÄ Drag and Drop for Google Credentials ‚îÄ‚îÄ
    const uploadArea = document.querySelector('.upload-area');
    if (uploadArea) {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
      });

      ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
      });

      uploadArea.addEventListener('drop', handleGoogleFileDrop, false);
    }

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function handleGoogleFileDrop(e) {
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.type === 'application/json' || file.name.endsWith('.json')) {
          const reader = new FileReader();
          reader.onload = function(event) {
            try {
              const json = JSON.parse(event.target.result);
              document.getElementById('google-json-text').value = JSON.stringify(json, null, 2);
            } catch (err) {
              alert('Invalid JSON file');
            }
          };
          reader.readAsText(file);
        } else {
          alert('Please drop a JSON file');
        }
      }
    }

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
    function escHtml(str) { const d = document.createElement('div'); d.textContent = str || ''; return d.innerHTML; }
    function timeAgo(date) {
      const s = Math.floor((Date.now() - date.getTime()) / 1000);
      if (s < 60) return 'just now';
      const m = Math.floor(s / 60); if (m < 60) return m + 'm ago';
      const h = Math.floor(m / 60); if (h < 24) return h + 'h ago';
      return Math.floor(h / 24) + 'd ago';
    }
    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => {
        const t = document.getElementById('copy-toast'); t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
      });
    }

    // ‚îÄ‚îÄ Modal handlers ‚îÄ‚îÄ
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => { if (e.target === e.currentTarget) modal.classList.remove('active'); });
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
    });

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
    if (new URLSearchParams(window.location.search).get('upgraded') === 'true') {
      history.replaceState(null, '', '/dashboard');
      setTimeout(() => {
        const t = document.getElementById('copy-toast');
        t.textContent = 'üéâ Plan upgraded!'; t.classList.add('show');
        setTimeout(() => { t.classList.remove('show'); t.textContent = '‚úì Copied'; }, 3000);
      }, 1000);
    }
    loadDashboard();
  </script>
</body>
</html>
